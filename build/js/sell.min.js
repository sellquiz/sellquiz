var sell=function(t,e){"use strict";function s(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(s){if("default"!==s){var i=Object.getOwnPropertyDescriptor(t,s);Object.defineProperty(e,s,i.get?i:{enumerable:!0,get:function(){return t[s]}})}})),e.default=t,Object.freeze(e)}var i=s(e);class r{static mat_idx(t,e,s,i){return s*e+i}static mat_get_row_count(t){return t.size()[0]}static mat_get_col_count(t){return t.size()[1]}static mat_get_element_value(t,e,s){return t.subset(i.index(e,s))}static mat_submatrix(t,e,s,r,n){let a=t.size()[0],l=t.size()[1];if(-1==s&&(s=a-1),-1==n&&(n=l-1),e>s||r>n)return null;if(e<0||r<0||e>=a||r>=l)return null;if(s<0||n<0||s>=a||n>=l)return null;let h=s-e+1,o=n-r+1,p=i.zeros(h,o);for(let a=e;a<=s;a++)for(let s=r;s<=n;s++){let n=t.subset(i.index(a,s));p=this.mat_set_element(p,a-e,s-r,n)}return p}static mat_rank(t){let e=t.size()[0],s=t.size()[1],r=[];for(let n=0;n<e;n++)for(let e=0;e<s;e++)r.push(t.subset(i.index(n,e)));let n=0,a=[];for(let t=0;t<s;t++)a.push(!1);for(let t=0;t<e;t++){let i;for(i=0;i<s&&(a[i]||!(Math.abs(r[this.mat_idx(e,s,t,i)])>1e-12));i++);if(i!=s){n++,a[i]=!0;for(let n=t+1;n<e;n++)r[this.mat_idx(e,s,n,i)]/=r[this.mat_idx(e,s,t,i)];for(let n=0;n<s;n++)if(n!=i&&Math.abs(r[this.mat_idx(e,s,t,n)])>1e-12)for(let a=t+1;a<e;a++)r[this.mat_idx(e,s,a,n)]-=r[this.mat_idx(e,s,a,i)]*r[this.mat_idx(e,s,t,n)]}}return n}static mat_is_symmetric(t){let e=t.size()[0],s=t.size()[1];if(e!=s)return!1;for(let e=0;e<s;e++)for(let r=e+1;r<s;r++){let s=t.subset(i.index(e,r)),n=t.subset(i.index(r,e));if(i.abs(s-n)>1e-14)return!1}return!0}static mat_triu(t){let e=t.size()[0],s=t.size()[1],r=i.zeros(e,s);for(let n=0;n<e;n++)for(let e=0;e<s;e++){let s=t.subset(i.index(n,e));e<n&&(s=0),r=r.subset(i.index(n,e),s)}return r}static mat_norm2(t){let e=t.size()[0],s=t.size()[1],r=0;for(let n=0;n<e;n++)for(let e=0;e<s;e++){let s=t.subset(i.index(n,e));r+=s*s}return i.sqrt(r)}static mat_vecdot(t,e){let s=t.size()[0],r=t.size()[1],n=e.size()[0],a=e.size()[1];1==r&&1==a&&s==n||assert(!1,"mat_vecdot(..): invalid input");let l=0;for(let r=0;r<s;r++)l+=t.subset(i.index(r,0))*e.subset(i.index(r,0));return l}static mat_veccross(t,e){let s=t.size()[0],r=t.size()[1],n=e.size()[0],a=e.size()[1];1==r&&1==a&&3==s&&3==n||assert(!1,"mat_veccross(..): invalid input");let l=this.mat_get_element_value(t,0,0),h=this.mat_get_element_value(t,1,0),o=this.mat_get_element_value(t,2,0),p=this.mat_get_element_value(e,0,0),u=this.mat_get_element_value(e,1,0),c=this.mat_get_element_value(e,2,0),m=i.zeros(3,1);return m=m.subset(i.index(0,0),h*c-o*u),m=m.subset(i.index(1,0),o*p-l*c),m=m.subset(i.index(2,0),l*u-h*p),m}static mat_is_row_zero(t,e,s,i){for(let r=0;r<s;r++)if(Math.abs(t[this.mat_idx(e,s,i,r)])>1e-12)return!1;return!0}static mat_is_zero(t){let e=t.size()[0],s=t.size()[1];for(let r=0;r<e;r++)for(let e=0;e<s;e++){let s=t.subset(i.index(r,e));if(Math.abs(s)>1e-12)return!1}return!0}static linsolve(t,e){return t.size()[0],t.size()[1],i.lusolve(t.clone(),e.clone())}static mat_kernel(t){let e=i.lup(t);u=e.U;let s,r=u.size()[0],n=u.size()[1],a=[];for(let t=0;t<r;t++)for(let e=0;e<n;e++)a.push(u.subset(i.index(t,e)));for(s=0;s<r&&!this.mat_is_row_zero(a,r,n,s);s++);for(let t=s-1;t>=1;t--)for(let e=t-1;e>=0;e--){let s=a[this.mat_idx(r,n,e,t)]/a[this.mat_idx(r,n,t,t)];for(let i=0;i<n;i++)a[this.mat_idx(r,n,e,i)]-=s*a[this.mat_idx(r,n,t,i)]}for(let t=0;t<s;t++){let e=a[this.mat_idx(r,n,t,t)];for(let s=0;s<n;s++)a[this.mat_idx(r,n,t,s)]/=e}let l=n,h=n-s,o=[];for(let t=0;t<l*h;t++)o.push(0);for(let t=0;t<h;t++)o[this.mat_idx(l,h,l-1-t,h-1-t)]=-1;for(let t=0;t<s;t++)for(let e=0;e<h;e++)o[this.mat_idx(l,h,t,e)]=a[this.mat_idx(r,n,t,e+s)];let p=i.zeros(l,h);for(let t=0;t<l;t++)for(let e=0;e<h;e++)p=p.subset(i.index(t,e),o[this.mat_idx(l,h,t,e)]);return o}static mat_set_element(t,e,s,r){let n=t.size()[0],a=t.size()[1];return e<0||e>=n||s<0||s>=a?null:t=t.subset(i.index(e,s),r)}static mat_mod(t,e){let s=t.size()[0],r=t.size()[1],n=i.zeros(s,r);for(let a=0;a<s;a++)for(let s=0;s<r;s++){let r=Math.round(t.subset(i.index(a,s)));r=i.mod(r,e),n=n.subset(i.index(a,s),r)}return n}static mat_compare_numerically(t,e){let s=t.size()[0],r=t.size()[1],n=e.size()[0],a=e.size()[1];if(s!=n&&r!=a)return!1;for(let n=0;n<s;n++)for(let s=0;s<r;s++){let r=t.subset(i.index(n,s)),a=e.subset(i.index(n,s));if(Math.abs(r-a)>1e-12)return!1}return!0}static mat_compare_numerically_except_scaling_factor(t,e){const s=1e-12;let r=t.size()[0],n=t.size()[1],a=e.size()[0],l=e.size()[1];if(r!=a&&n!=l)return!1;let h=!0,o=1;for(let a=0;a<r;a++)for(let r=0;r<n;r++){let n=t.subset(i.index(a,r)),l=e.subset(i.index(a,r));if(Math.abs(n*o-l)>s){if(!h)return!1;if(h=!1,Math.abs(n)<s||Math.abs(l)<s)return!1;o=l/n}}return!0}}class n{constructor(t,e){this.type=t,this.v=e,this.deriv=null}}class a{constructor(t=[]){this.symbolIDs=t,this.stack=[],this.state="",this.contains_forbidden_ode_subtree=!1}clear(){this.stack=[]}importMathJsTerm(t){let e=i.parse(t);return this.importMathJsTermJsRecursively(e)}importMathJsTermJsRecursively(t){switch(t.type){case"ConstantNode":this.pushConstant(t.value);break;case"SymbolNode":this.pushVariable(t.name);break;case"OperatorNode":case"ParenthesisNode":for(;"ParenthesisNode"==t.type;)t=t.content;if("unaryMinus"==t.fn){if(0==this.importMathJsTermJsRecursively(t.args[0]))return!1;this.pushUnaryOperation("-")}else{if("+"!=t.op&&"-"!=t.op&&"*"!=t.op&&"/"!=t.op&&"^"!=t.op)return console.log("warning: SellSymTerm::importMathJsTermJsRecursively(..): unknown/unimplemented operation "+t.op),!1;if(0==this.importMathJsTermJsRecursively(t.args[0]))return!1;if(0==this.importMathJsTermJsRecursively(t.args[1]))return!1;this.pushBinaryOperation(t.op)}break;case"FunctionNode":if("exp"!=t.name&&"sin"!=t.name&&"cos"!=t.name&&"sqrt"!=t.name)return console.log("warning: SellSymTerm::importMathJsTermJsRecursively(..): unknown/unimplemented function "+t.name),!1;if(0==this.importMathJsTermJsRecursively(t.args[0]))return!1;this.pushUnaryFunction(t.name);break;default:return console.log("warning: SellSymTerm::importMathJsTermJsRecursively(..): unknown/unimplemented node type "+t.type),!1}return!0}pushVariable(t){this.stack.push(new n("var",t))}pushOdeFunction(t){this.stack.push(new n("ode_fun",t))}pushConstant(t){t=parseFloat(t),this.stack.push(new n("const",t))}pushSymbolicTerm(t){0==t.stack.length?this.stack.push(new n("const",0)):this.stack.push(t.stack[0])}pushUnaryFunction(t){let e=this.stack.pop();this.stack.push(new n("fct1",[t,e]))}pushBinaryFunction(t){let e=this.stack.pop(),s=this.stack.pop();this.stack.push(new n("fct2",[t,s,e]))}pushDiff(){let t=this.stack.pop(),e=this.stack.pop(),s=new a;s.symbolIDs=this.symbolIDs,s.stack.push(e);let i=s.derivate(t.v);this.pushSymbolicTerm(i)}pushUnaryOperation(t){let e=this.stack.pop();this.stack.push(new n("uniop",[t,e]))}pushBinaryOperation(t){t=t.replace("add","+").replace("sub","-").replace("mul","*").replace("div","/").replace("pow","^");let e=this.stack.pop(),s=this.stack.pop();if("const"==s.type&&"const"==e.type){let r=0;switch(t){case"+":r=s.v+e.v;break;case"-":r=s.v-e.v;break;case"*":r=s.v*e.v;break;case"/":r=s.v/e.v;break;case"^":r=i.pow(s.v,e.v);break;default:alert("unimplemented: SellSymTerm:pushBinaryOperation(..): operator "+t)}this.stack.push(new n("const",r))}else this.stack.push(new n("binop",[t,s,e]))}appendVariableSet(t,e){for(let s=0;s<e.length;s++){let i=!1;for(let r=0;r<t.length;r++)if(e[s]===t[r]){i=!0;break}0==i&&t.push(e[s])}}getVariables(t=null){let e,s,i=[];switch(null==t&&(t=this.stack[0]),t.type){case"var":this.appendVariableSet(i,[t.v]);break;case"const":break;case"uniop":e=this.getVariables(t.v[1]),this.appendVariableSet(i,e);break;case"binop":e=this.getVariables(t.v[1]),this.appendVariableSet(i,e),s=this.getVariables(t.v[2]),this.appendVariableSet(i,s);break;case"ode_fun":this.appendVariableSet(i,[t.v]);break;case"fct1":e=this.getVariables(t.v[1]),this.appendVariableSet(i,e);break;case"fct2":e=this.getVariables(t.v[1]),this.appendVariableSet(i,e),s=this.getVariables(t.v[2]),this.appendVariableSet(i,s);break;default:alert("unimplemented: SellSymTerm:getVariables(..): "+t.type)}return i}getOdeOrder(t=null){let e=0;switch(null==t&&(t=this.stack[0]),t.type){case"uniop":e=i.max(e,this.getOdeOrder(t.v[1]));break;case"binop":e=i.max(e,this.getOdeOrder(t.v[1])),e=i.max(e,this.getOdeOrder(t.v[2]));break;case"fct2":"diff_ode"==t.v[0]?e=i.max(e,1):"diff2_ode"==t.v[0]&&(e=i.max(e,2))}return e}optimizeOdeConstants(t=null){let e,s,i;switch(null==t&&(t=this.stack[0]),t.type){case"var":break;case"uniop":this.optimizeOdeConstants(t.v[1]),e=t.v[1],"var"===e.type&&e.v.startsWith("C")&&(t.type="var",t.v=e.v);break;case"binop":this.optimizeOdeConstants(t.v[1]),this.optimizeOdeConstants(t.v[2]),s=t.v[1],i=t.v[2],"var"===s.type&&s.v.startsWith("C")&&"const"===i.type?(t.type="var",t.v=s.v):"var"===i.type&&i.v.startsWith("C")&&"const"===s.type&&(t.type="var",t.v=i.v);break;case"fct1":this.optimizeOdeConstants(t.v[1]),e=t.v[1],"var"===e.type&&e.v.startsWith("C")&&(t.type="var",t.v=e.v)}}searchForForbiddenODESecondOrderSubterms(t=null){let e,s,i=[];switch(null==t&&(t=this.stack[0]),t.type){case"var":this.appendVariableSet(i,[t.v]);break;case"const":break;case"uniop":e=this.searchForForbiddenODESecondOrderSubterms(t.v[1]),this.appendVariableSet(i,e);break;case"binop":e=this.searchForForbiddenODESecondOrderSubterms(t.v[1]),this.appendVariableSet(i,e),s=this.searchForForbiddenODESecondOrderSubterms(t.v[2]),this.appendVariableSet(i,s);break;case"ode_fun":this.appendVariableSet(i,[t.v]);break;case"fct1":e=this.searchForForbiddenODESecondOrderSubterms(t.v[1]),this.appendVariableSet(i,e);break;case"fct2":e=this.searchForForbiddenODESecondOrderSubterms(t.v[1]),this.appendVariableSet(i,e),s=this.searchForForbiddenODESecondOrderSubterms(t.v[2]),this.appendVariableSet(i,s);break;default:alert("unimplemented: SellSymTerm:searchForForbiddenODESecondOrderSubterms(..): "+t.type)}if(console.log("TEST:"),console.log(i),2==i.length){this.contains_forbidden_ode_subtree=!0;for(let t=0;t<i.length;t++)0==i[t].startsWith("C")&&(this.contains_forbidden_ode_subtree=!1)}return i}getOperator(t){let e="";return"uniop"!=t.type&&"binop"!=t.type||(e=t.v[0]),e}getOperatorPrecedence(t){let e=0;switch(t){case"+":case"-":e=10;break;case"*":case"/":e=20;break;case"^":e=30;break;case"":e=99;break;default:alert("unimplemented: SellSymTerm:getOperatorPrecedence(..): op="+t)}return e}toString(t=null){let e,s,r,n,a="",l=!1;switch(null==t&&(l=!0,t=this.stack[0]),t.type){case"var":a=t.v;break;case"const":a=t.v.toString(),i.abs(t.v-3.141592653589793)<1e-12&&(a="pi");break;case"uniop":a=t.v[0]+this.toString(t.v[1]),"uniop"==t.v[1].type&&(a="("+a+")");break;case"ode_fun":a=t.v.id+"("+t.v.mathsymbol_ids[0]+")";break;case"binop":let l=this.toString(t.v[1]),h=this.toString(t.v[2]),o=t.v[0],p=this.getOperatorPrecedence(o),u=this.getOperator(t.v[1]),c=this.getOperatorPrecedence(u),m=this.getOperator(t.v[2]),d=this.getOperatorPrecedence(m);(c<p||"/"===o)&&(l="("+l+")"),d<p||"uniop"==m.type||h.startsWith("-")?h="("+h+")":"-"!==o&&"/"!==o||"const"!==t.v[2].type&&(h="("+h+")"),a=l+o+h;break;case"fct1":e=t.v[0],s=this.toString(t.v[1]),a="exp"===e&&s.length<5?"e^("+s+")":e+"("+s+")";break;case"fct2":e=t.v[0],"diff_ode"===e?a=t.v[1].v.id+"'("+t.v[2].v+")":"diff2_ode"===e?a=t.v[1].v.id+"''("+t.v[2].v+")":(r=this.toString(t.v[1]),n=this.toString(t.v[2]),a=e+"("+r+", "+n+")");break;default:alert("unimplemented: SellSymTerm:toString(..): "+t.type)}return l&&a.startsWith("(")&&(a=a),a}derivate(t,e=null){let s,i,r,l,h,o=null==e;switch(o&&(e=this.stack[0]),e.type){case"var":e.deriv=new n("const",e.v==t?1:0);break;case"const":e.deriv=new n("const",0);break;case"uniop":switch(s=e.v[1],this.derivate(t,s),r=e.v[0],r){case"-":e.deriv=new n("uniop",[r,s.deriv]);break;default:alert("unimplemented: SellSymTerm:derivate(..): uniop: "+r)}break;case"binop":switch(s=e.v[1],this.derivate(t,s),i=e.v[2],this.derivate(t,i),r=e.v[0],r){case"+":case"-":e.deriv=new n("binop",[r,s.deriv,i.deriv]);break;case"*":e.deriv=new n("binop",["+",new n("binop",["*",s.deriv,i]),new n("binop",["*",i.deriv,s])]);break;case"/":e.deriv=new n("binop",["/",new n("binop",["-",new n("binop",["*",s.deriv,i]),new n("binop",["*",i.deriv,s])]),new n("binop",["*",i,i])]);break;case"^":"const"!==i.type&&alert("unimplemented: SellSymTerm:derivate(..): derivation of u^v with v != const"),e.deriv=new n("binop",["*",s.deriv,new n("binop",["*",i,new n("binop",["^",s,new n("binop",["-",i,new n("const",1)])])])]);break;default:alert("unimplemented: SellSymTerm:derivate(..): binop: "+r)}break;case"fct1":switch(l=e.v[0],h=e.v[1],this.derivate(t,h),l){case"sin":e.deriv=new n("binop",["*",h.deriv,new n("fct1",["cos",h])]);break;case"cos":e.deriv=new n("uniop",["-",new n("binop",["*",h.deriv,new n("fct1",["sin",h])])]);break;case"exp":e.deriv=new n("binop",["*",h.deriv,new n("fct1",["exp",h])]);break;case"sqrt":e.deriv=new n("binop",["/",h.deriv,new n("binop",["*",new n("const",2),new n("fct1",["sqrt",h])])]);break;default:alert("unimplemented: SellSymTerm:derivate(..): fct1: "+l)}break;default:alert("unimplemented: SellSymTerm:derivate(..): "+e.type)}if(o){let t=new a;return t.symbolIDs=this.symbolIDs,t.stack=[this.stack[0].deriv],t.optimize(),t}return null}eval(t,e=null){let s,r,n,a,l,h=0;switch(null==e&&(e=this.stack[0]),e.type){case"var":if(!(e.v in t))return alert("SellSymTerm:eval(..): variable "+e.v+" has no value!"),0;h=parseFloat(t[e.v]);break;case"const":h=e.v;break;case"uniop":switch(s=this.eval(t,e.v[1]),n=e.v[0],n){case"-":h=-s;break;default:alert("unimplemented: SellSymTerm:eval(..): uniop: "+n)}break;case"binop":switch(s=this.eval(t,e.v[1]),r=this.eval(t,e.v[2]),n=e.v[0],n){case"+":h=s+r;break;case"-":h=s-r;break;case"*":h=s*r;break;case"/":h=s/r;break;case"^":h=i.pow(s,r);break;default:alert("unimplemented: SellSymTerm:eval(..): binop: "+n)}break;case"fct1":switch(a=e.v[0],l=this.eval(t,e.v[1]),a){case"sin":h=i.sin(l);break;case"cos":h=i.cos(l);break;case"exp":h=i.exp(l);break;case"sqrt":h=i.sqrt(l);break;default:alert("unimplemented: SellSymTerm:eval(..): fct1: "+a)}break;case"fct2":switch(a=e.v[0],a){case"diff_ode":case"diff2_ode":let s=null,i=e.v[1].v.id;i in t?s=t[i]:alert("SellSymTerm:eval(..): unknown term "+i);let r=e.v[2].v,n=s.derivate(r);"diff2_ode"===a&&(n=n.derivate(r)),h=n.eval(t);break;default:alert("unimplemented: SellSymTerm:eval(..): fct1: "+a)}break;case"ode_fun":let o=e.v.id,p=null;o in t?p=t[o]:alert("SellSymTerm:eval(..): unknown term "+o),h=p.eval(t);break;default:alert("unimplemented: SellSymTerm:eval(..): "+e.type)}return h}optimize(t=null){let e,s,i,r=null==t;if(r&&(t=this.stack[0]),"uniop"===t.type)e=t.v[0],s=this.optimize(t.v[1]),t.v[1]=s,"-"===e&&"const"==s.type&&0==s.v&&(t.type="const",t.v=0);else if("fct1"===t.type)s=this.optimize(t.v[1]),t.v[1]=s;else if("binop"===t.type)if(e=t.v[0],s=this.optimize(t.v[1]),t.v[1]=s,i=this.optimize(t.v[2]),t.v[2]=i,"const"===s.type&&"const"===i.type)switch(t.type="const",e){case"+":t.v=s.v+i.v;break;case"-":t.v=s.v-i.v;break;case"*":t.v=s.v*i.v;break;case"/":t.v=s.v/i.v;break;default:alert("unimplemented: SellSymTerm:optimize(..): binop: "+e)}else"*"===e&&("const"===s.type&&0==s.v||"const"===i.type&&0==i.v)?(t.type="const",t.v=0):"*"===e&&"const"===s.type&&1==s.v?(t.type=i.type,t.v=i.v):"*"===e&&"const"===s.type&&-1==s.v?t=new n("uniop",["-",i]):"*"===e&&"const"===i.type&&1==i.v?(t.type=s.type,t.v=s.v):"*"===e&&"const"===i.type&&-1==s.v?t=new n("uniop",["-",s]):"+"===e&&"const"===s.type&&0==s.v?(t.type=i.type,t.v=i.v):"+"===e&&"const"===i.type&&0==i.v||"-"===e&&"const"===i.type&&0==i.v||"^"===e&&"const"===i.type&&1==i.v?(t.type=s.type,t.v=s.v):"-"===e&&"uniop"===i.type&&"-"===i.v[0]?t=new n("binop",["+",s,i.v[1]]):"+"===e&&"uniop"===i.type&&"-"===i.v[0]&&(t=new n("binop",["-",s,i.v[1]]));return r&&(this.stack[0]=t),t}integrateNumerically(t,e,s){if(s<e)return-this.integrateNumerically(v,s,e);let i=(s-e)/1e6,r=0;for(let t=e;t<s;t+=i){r+=(this.eval({varId:t})+this.eval({varId:t+i}))/2*i}return r}compareWithStringTerm(t,e=[]){this.state="",0==t.length&&(t="0");let s=this.getVariables();e.length>0&&(s=e);for(let e=0;e<50;e++){let r={};for(let t=0;t<s.length;t++)r[s[t]]=i.random(-10,10);let n=this.eval(r);if(n>1e3){e--;continue}let a=0;try{a=i.evaluate(t,r)}catch(t){return this.state="syntaxerror",!1}if("number"!=typeof a)return this.state="syntaxerror",!1;if(i.abs(n-a)>=1e-9)return!1}return!0}}function l(t,e=""){t||alert(e)}const h={T_UNKNOWN:"T_UNKNOWN",T_REAL:"T_REAL",T_DOTS:"T_DOTS",T_SET:"T_SET",T_BOOL:"T_BOOL",T_FUNCTION:"T_FUNCTION",T_COMPLEX:"T_COMPLEX",T_COMPLEX_SET:"T_COMPLEX_SET",T_MATRIX:"T_MATRIX",T_MATRIX_DEF:"T_MATRIX_DEF",T_MATRIX_TRANSPOSE:"T_MATRIX_TRANSPOSE",T_STRING:"T_STRING",T_STRING_LIST:"T_STRING_LIST"};class o{constructor(t=h.UNKNOWN,e=null,s=1e-9){this.type=t,this.value=e,this.precision=s,this.user_value="",this.hint_html=""}toAsciiMath(){let t="";switch(this.type){case h.T_BOOL:return this.value?"true":"false";case h.T_UNKNOWN:return"ERROR";case h.T_REAL:return this.value;case h.T_DOTS:return"...";case h.T_SET:case h.T_COMPLEX_SET:t="{ ";for(let e=0;e<this.value.length;e++)t+=(e>0?", ":"")+this.value[e].toAsciiMath();return t+=" }",t;case h.T_FUNCTION:case h.T_COMPLEX:return t=this.value.toString(),t;case h.T_MATRIX:return t=this.value.toString(),t=t.replaceAll("[","(").replaceAll("]",")"),t;default:l(!1,"unimplemented SellSymbol::toAsciiMath(..)")}}}class p{constructor(){this.src="",this.html="",this.symbols={},this.lastParsedInputSymbol=null,this.solutionSymbols={},this.solutionSymbolsMustDiffFirst={},this.stack=[]}}class c{constructor(t,e,s){this.str=t,this.line=e,this.col=s}}class m{static isAlpha(t){return t>="A"&&t<="Z"||t>="a"&&t<="z"||"_"==t||"Ä"==t||"Ö"==t||"Ü"==t||"ß"==t||"ä"==t||"ö"==t||"ü"==t}static isNum(t){return t>="1"&&t<="9"}static isNum0(t){return"0"==t||this.isNum(t)}static isIdentifier(t){for(let e=0;e<t.length;e++){let s=t[e];if(0==e){if(0==this.isAlpha(s))return!1}else if(0==this.isAlpha(s)&&0==this.isNum0(s))return!1}return!0}static isInteger(t){if(0==t.length)return!1;let e=0;if("-"===t[0]&&(e=1,1==t.length))return!1;for(let s=e;s<t.length;s++){let e=t[s];if(0==this.isNum0(e))return!1}return!0}static isReal(t){return 0==isNaN(parseFloat(t))}static tokenize(t){let e=new Array,s="",i=1,r=1,n=1,a=!t.startsWith("\t")&&!t.startsWith("    ");for(let l=0;l<t.length;l++){let h=t[l],o="";l<t.length-1&&(o=t[l+1]);let p="";switch(l<t.length-2&&(p=t[l+2]),h){case" ":case"\t":case"\n":s.length>0&&e.push(new c(s,r,i)),s="",i=n,"\n"===h?(r++,n=0):" "===h&&e.push(new c(h,r,i));break;case"_":a?(s.length>0&&e.push(new c(s,r,i)),s="",i=n,"_"==h&&"_"==o&&(h="__",l++),e.push(new c(h,r,i)),i=n):(0==s.length&&(i=n),s+=h);break;case"(":case")":case"{":case"}":case"[":case"]":case"+":case"-":case"*":case"/":case"^":case"~":case"#":case".":case",":case";":case":":case"=":case"@":case"|":case"$":case"?":case"!":case'"':case"<":case">":case"`":case"\\":case"'":s.length>0&&e.push(new c(s,r,i)),s="",i=n,":"==h&&"="==o?(h=":=",l++):"^"==h&&"^"==o?(h="^^",l++):"\\"==h&&"\\"==o?(h="\\\\",l++):"-"==h&&">"==o?(h="->",l++):"|"==h&&"-"==o&&">"==p?(h="|->",l+=2):"<"==h&&"="==o?(h="<=",l++):">"==h&&"="==o?(h=">=",l++):"="==h&&"="==o?(h="==",l++):"!"==h&&"="==o?(h="!=",l++):"."==h&&"."==o&&"."==p?(h="...",l+=2):"`"==h&&"`"==o&&"`"==p&&(h="```",l+=2),e.push(new c(h,r,i)),i=n;break;default:0==s.length&&(i=n),s+=h}n++}return s.length>0&&e.push(new c(s,r,i)),e}static printTokenList(t){for(let e=0;e<t.length;e++){let s=t[e];console.log(s.line+":"+s.col+":"+s.str)}}static randomInt(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t)+t)}static splitStringAndKeepDelimiters(t,e){let s=Array(),i="";for(let r=0;r<t.length;r++){let n=!0,a="";for(let s=0;s<e.length;s++){let i=e[s];if(n=!0,r+i.length>t.length)n=!1;else for(let e=0;e<i.length;e++)if(t[r+e]!=i[e]){n=!1;break}if(n){a=i;break}}n?(i.length>0&&(s.push(i),i=""),s.push(a),r+=a.length-1):i+=t[r]}return i.length>0&&s.push(i),s}}class d{constructor(t,e,s,i,r,n=!1,a=!1,l=!1){this.environment=t,this.sellInstanceID=e,this.id=s,this.m=i,this.n=r,this.wideInput=n,this.resizableRows=a,this.resizableCols=l}getElementByIdAndType(t,e){if("mumie"==this.environment){let s;return s=Array.from(document.getElementsByTagName(e)).filter((e=>e.id===t)).find((t=>null!==t.offsetParent)),s||document.getElementById(t)}return document.getElementById(t)}resize(t,e){this.m+=t,this.n+=e,this.m=this.m<1?1:this.m,this.n=this.n<1?1:this.n,this.updateHTML()}getElementText(t,e){return this.getElementByIdAndType(this.sellInstanceID+"_"+this.id+"_"+t+"_"+e,this.ELEMENT_TYPE_INPUT).value}setElementText(t,e,s){this.getElementByIdAndType(this.sellInstanceID+"_"+this.id+"_"+t+"_"+e,this.ELEMENT_TYPE_INPUT).value=s}setUnsetElementsToZero(){for(let t=0;t<this.m;t++)for(let e=0;e<this.n;e++){0==this.getElementText(t,e).length&&this.setElementText(t,e,"0")}}updateHTML(){let t=this.wideInput?20:4,e="";e+="<span>\n",e+='<table class="p-0 m-0" style="display:inline-block;border-spacing:0;border-collapse:collapse;">\n',e+="    <tr>\n",e+="        <td>\n",e+='            <table style="border-spacing:0;border-collapse:collapse;border-left:2px solid black;border-right:2px solid black;">\n';for(let s=0;s<this.m;s++){e+="                <tr>\n",0==s?e+='                    <td style="border-top:2px solid black;"></td>\n':s==this.m-1?e+='                    <td style="border-bottom:2px solid black;"></td>\n':e+="                    <td></td>\n";for(let i=0;i<this.n;i++)e+="                    <td>\n",e+='            <input type="text" id="'+this.sellInstanceID+"_"+this.id+"_"+s+"_"+i+'" size="'+t+'" placeholder=""/>\n',e+="                    </td>\n";0==s?e+='                    <td style="border-top:2px solid black;"></td>\n':s==this.m-1?e+='                    <td style="border-bottom:2px solid black;"></td>\n':e+="<td></td>\n",e+="                </tr>\n"}e+="            </table>\n",e+="        </td>\n",this.resizableCols&&(e+='        <td style="text-align:left">\n',e+='            <button class="matrix_size_button" style="font-size:18px;padding:0;border:none;background:none;" onclick="'+this.sellInstanceID+".resizeMatrixInput('"+this.id+"',0,1);\">&nbsp;&#8853;</button>\n",e+="            <br/>\n",e+='            <button class="matrix_size_button" style="font-size:18px;padding:0;border:none;background:none;" onclick="'+this.sellInstanceID+".resizeMatrixInput('"+this.id+"',0,-1);\">&nbsp;&#8854;</button>\n",e+="        </td>\n"),e+="    </tr>\n",e+="    <tr>\n",this.resizableRows&&(e+='    <td style="text-align:center">\n',e+='        <button class="matrix_size_button" style="font-size:18px;padding:0;border:none;background:none;" onclick="'+this.sellInstanceID+".resizeMatrixInput('"+this.id+"',1,0);\">&#8853;</button>\n",e+="        &nbsp;\n",e+='        <button class="matrix_size_button" style="font-size:18px;padding:0;border:none;background:none;" onclick="'+this.sellInstanceID+".resizeMatrixInput('"+this.id+"',-1,0);\">&#8854;</button>\n",e+="    </td>\n"),e+="        <td></td>\n",e+="    </tr>\n",e+="</table>\n",e+="</span>\n",this.getElementByIdAndType(this.id,this.ELEMENT_TYPE_SPAN).innerHTML=e}}function _(t="",e=""){const s=Array(e.length+1).fill(null).map((()=>Array(t.length+1).fill(null)));for(let e=0;e<=t.length;e+=1)s[0][e]=e;for(let t=0;t<=e.length;t+=1)s[t][0]=t;for(let i=1;i<=e.length;i+=1)for(let r=1;r<=t.length;r+=1){const n=t[r-1]===e[i-1]?0:1;s[i][r]=Math.min(s[i][r-1]+1,s[i-1][r]+1,s[i-1][r-1]+n)}return s[e.length][t.length]}return t.Sell=class{constructor(t="en",e="sell",s=!1,i="standalone"){l(!0),this.ELEMENT_TYPE_INPUT="input",this.ELEMENT_TYPE_SPAN="span",this.debug=s,this.log="",this.language=t,this.instanceID=e,this.environment=i,this.questions=[],this.q=null,this.qidx=0,this.html="",this.variablesJsonStr="",this.tokens=[],this.tk="",this.tk_line=0,this.tk_col=0,this.tk2="",this.tkIdx=0,this.id="",this.parsingInlineCode=!1,this.isBoldFont=!1,this.isItalicFont=!1,this.isItemize=!1,this.isItemizeItem=!1,this.singleMultipleChoiceFeedbackHTML="",this.matrixInputs=[],this.resizableRows=!1,this.resizableCols=!1,this.uniqueIDCtr=0,this.editButton=!1}getElementByIdAndType(t,e){if("mumie"==this.environment){let s;return s=Array.from(document.getElementsByTagName(e)).filter((e=>e.id===t)).find((t=>null!==t.offsetParent)),s||document.getElementById(t)}return document.getElementById(t)}backupLexer(){return{tk:this.tk,tk_line:this.tk_line,tk_col:this.tk_col,tk2:this.tk2,tkIdx:this.tkIdx,id:this.id}}replayLexer(t){this.tk=t.tk,this.tk_line=t.tk_line,this.tk_col=t.tk_col,this.tk2=t.tk2,this.tkIdx=t.tkIdx,this.id=t.id}createUniqueID(){return"ID"+this.uniqueIDCtr++}updateMatrixInputs(){for(let t=0;t<this.matrixInputs.length;t++)this.matrixInputs[t].updateHTML()}resizeMatrixInput(t,e,s){for(let i=0;i<this.matrixInputs.length;i++)if(this.matrixInputs[i].id===t){this.matrixInputs[i].resize(e,s);break}}importQuestions(t){let e=(t=t.split("STOP")[0]).split("\n"),s="",i=0;for(let t=0;t<e.length;t++){let r=e[t];if(r.startsWith("%%%")){if(!this.importQuestion(s,i))return!1;s="",i=t+1}else s+=r+"\n"}if(!this.importQuestion(s,i))return!1;if("moodle"==this.environment)for(let t=0;t<this.questions.length;t++){let e=this.questions[t];this.variablesJsonStr=JSON.stringify({symbols:e.symbols,solutionSymbols:e.solutionSymbols})}return!0}importQuestion(t,e=0){this.resizableRows=!1,this.resizableCols=!1,this.tokens=[],this.tk="",this.tk_line=0,this.tk_col=0,this.tk2="",this.tkIdx=0,this.id="",this.qidx=this.questions.length,this.q=new p,this.q.src=t,this.questions.push(this.q);let s=t.split("\n"),i=!1,r=!1;for(let t=0;t<s.length;t++){!r&&s[t].startsWith("```")&&(r=!0);let n=s[t].startsWith("\t\t")||s[t].startsWith("        "),a=s[t].startsWith("\t")||s[t].startsWith("    ");n&&(a=!1);let l=s[t].split("%")[0];if(0==l.length)continue;let h=m.tokenize(l);if(0!=h.length){h.push(new c("§EOL",t+1,-1)),r||(!a&&i&&this.tokens.push(new c("§CODE_END",t+1,-1)),a&&!i&&this.tokens.push(new c("§CODE_START",t+1,-1)));for(let s=0;s<h.length;s++)this.tokens.push(h[s]),this.tokens[this.tokens.length-1].line=e+t+1;i=a,r&&s[t].endsWith("```")&&(r=!1)}}this.tokens.push(new c("§END",-1,-1)),this.tkIdx=0,this.next();try{this.parse()}catch(t){return this.log+=t+"\n",this.log+="Error: compilation failed",!1}if("§END"!==this.tk)return this.error('Error: remaining tokens: "'+this.tk+'"...');this.log+="... compilation succeeded!\n";let n=[],a=this.q.html.length,l="";for(let t=0;t<a;t++){let e=this.q.html[t],s=t+1<a?this.q.html[t+1]:"";if("§"==e&&"["==s){l+="§"+n.length,n.push("");for(let i=t+2;i<a;i++){if(e=this.q.html[i],s=i+1<a?this.q.html[i+1]:"","]"==e&&"§"==s){t=i+1;break}n[n.length-1]+=e}}else l+=e}let h=n.length;for(let t=0;t<h;t++){let t=m.randomInt(0,h),e=m.randomInt(0,h),s=n[t];n[t]=n[e],n[e]=s}for(let t=0;t<h;t++)l=l.replace("§"+t,n[t]);return this.q.html=l,this.html+=this.q.html+"\n\n",!0}next(){if(this.tkIdx>=this.tokens.length?(this.tk="§END",this.tk_line=-1,this.tk_col=-1):(this.tk=this.tokens[this.tkIdx].str,this.tk_line=this.tokens[this.tkIdx].line,this.tk_col=this.tokens[this.tkIdx].col),this.tkIdx+1>=this.tokens.length?this.tk2="§END":this.tk2=this.tokens[this.tkIdx+1].str,this.tkIdx++,this.parseWhitespaces||" "!==this.tk||this.next(),this.parsingInlineCode&&m.isIdentifier(this.tk))for(;this.parsingInlineCode&&this.tkIdx<this.tokens.length-1&&"§END"!==!this.tk&&("_"===this.tokens[this.tkIdx].str||m.isIdentifier(this.tokens[this.tkIdx].str)||m.isInteger(this.tokens[this.tkIdx].str));)this.tk+=this.tokens[this.tkIdx].str,this.tk_line=this.tokens[this.tkIdx].line,this.tk_col=this.tokens[this.tkIdx].col,this.tkIdx++;this.parseWhitespaces||" "!==this.tk||this.next()}err(t){throw"Error:"+this.tk_line+":"+this.tk_col+": "+t}terminal(t){this.tk===t?this.next():this.err("§EOL"==t?"expected linebreak, got '"+this.tk+"'":"expected '"+t+"'")}ident(){this.isIdent(this.tk)?(this.id=this.tk,this.next()):this.err("expected identifier")}isIdent(){return m.isIdentifier(this.tk)}isNumber(){return!isNaN(this.tk)}isInt(){return m.isInteger(this.tk)}is(t){return this.tk===t}is2(t){return this.tk2===t}pushSym(t,e,s=1e-9){this.q.stack.push(new o(t,e,s))}charToHTML(t){switch(t){case"§EOL":return"<br/>\n";default:return t}}parse(){for(this.q.html+='<div class="card">\n',this.parseTitle();!this.is("§END");)this.is("§CODE_START")?this.parseCode():this.parseText();this.q.html+="</div>\n",this.q.html+='<div class="card-footer bg-white pl-4 pt-2 pb-1 m-0">',this.q.html+="<span>","moodle"!==this.environment&&(this.q.html+='<input id="button-evaluate" type="image" onclick="'+this.instanceID+".evaluateUserInput("+this.qidx+')" height="28px" src="img/check-square.svg" title="evaluate"/>'),this.editButton&&(this.q.html+='&nbsp;&nbsp;<button type="button" class="btn btn-link" onclick="editSellQuestion('+this.qidx+')">edit</button>'),this.q.html+='&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id="sell_input_feedback_'+this.instanceID+"_"+this.qidx+'_general_feedback"></span>',this.q.html+="</span>",this.q.html+="</div>",this.q.html+="</div>\n",this.q.html+="<br/>"}parseTitle(){this.parseWhitespaces=!0;let t="";for(;!this.is("§EOL")&&!this.is("§END");)this.isIdent()?(t+=this.tk,this.next()):this.is("#")?(this.next(),this.isIdent()?(this.tk,this.next()):this.err("expected identifer after '#'")):(t+=this.charToHTML(this.tk),this.next());this.terminal("§EOL"),this.parseWhitespaces=!1,this.q.html+='<div class="card-header">\n',this.q.html+='    <h5 class="card-title m-0">'+t+"</h5>\n",this.q.html+='    <a name="question-'+(this.questions.length-1)+'"></a>\n',this.q.html+="</div>\n",this.q.html+='<div class="card-body p-4">\n'}parseCode(){for(this.terminal("§CODE_START");!this.is("§CODE_END")&&!this.is("§END");)this.is("input")?this.parseCodeProp():this.is("?")?this.parseCodeHint():this.parseAssign(),this.terminal("§EOL");this.is("§END")||this.terminal("§CODE_END")}parseCodeProp(){this.is("input")?this.next():this.err("expected input");let t=!1;this.is("rows")?(this.next(),t=!0):this.is("cols")?(this.next(),t=!1):this.err("expected 'rows' or 'cols'"),this.terminal(":=");let e=!0;this.is("resizable")?(this.next(),e=!0):this.is("static")?(this.next(),e=!1):this.err("expected 'resizable' or 'static'"),t?this.resizableRows=e:this.resizableCols=e}parseCodeHint(){this.is("?")?this.next():this.err("expected ?");let t=this.q.lastParsedInputSymbol;null==t&&this.err("Hint/explanation is forbidden, since there is no preceding input field");let e=this.q.html.length;this.parseText(!0),t.hint_html=this.q.html.substr(e),this.q.html=this.q.html.substr(0,e)}chooseFromSet(t){let e;if(4==t.length&&t[2].type===h.T_DOTS){let s=t[0].value,i=t[3].value,r=parseFloat(t[1].value)-s;e=Math.floor(Math.random()*(i-s+r)/r)*r+s}else{e=t[Math.floor(Math.random()*t.length)].value}return e}parseAssign(){this.q.stack=[];let t=!1,e=[],s=[],n=!1,a=0,l=0;if(this.ident(),e.push(this.id),"i"!==this.id&&"e"!==this.id||this.err("id '"+this.id+"' is a reserved symbol"),this.is("(")){for(t=!0,this.next(),this.ident(),s.push(this.id);this.is(",");)this.next(),this.ident(),s.push(this.id);this.terminal(")")}else if(this.is("[")){this.next(),n=!0,this.parseExpr();let t=this.q.stack.pop();t.type==h.T_REAL&&m.isInteger(t.value)||this.err("row index is not an integer value"),a=t.value,this.terminal(","),this.parseExpr(),t=this.q.stack.pop(),t.type==h.T_REAL&&m.isInteger(t.value)||this.err("column index is not an integer value"),l=t.value,this.terminal("]")}else for(;this.is(",");)this.next(),this.ident(),e.push(this.id);if(this.is(":=")||this.is("=")){this.next(),t?this.parseSymbolicTerm(s):this.parseExpr();let i=this.q.stack.pop();if(n){i.type!=h.T_REAL&&this.err("right-hand side must be of type real"),e[0]in this.q.symbols||this.err("unkown symbol '"+e[0]+"'");let t=this.q.symbols[e[0]];t.type!=h.T_MATRIX&&this.err("symbol '"+e[0]+"' is not a matrix"),t.value=r.mat_set_element(t.value,a-1,l-1,i.value),null==t.value&&this.err("invalid indices")}else for(let t=0;t<e.length;t++)this.q.symbols[e[t]]=i}else if(this.is("in"))if(t&&this.err("cannot apply 'in' to a function"),this.next(),this.is("MM")){this.parseMatrixDef();let t=this.q.stack.pop(),s=t.value[0],r=t.value[1],n=t.value[2],a=t.value[3],l=t.value[4];for(let t=0;t<e.length;t++){let p=i.zeros(s,r),u=0;do{for(let t=0;t<s;t++)for(let e=0;e<r;e++){let s=this.chooseFromSet(n.value);p.subset(i.index(t,e),s)}if(l)for(let t=1;t<s;t++)for(let e=0;e<t;e++){let s=p.subset(i.index(t,e));p=p.subset(i.index(e,t),s)}if(!a)break;u>256&&this.err("matrix generation failed: too many iterations"),u++}while(i.abs(i.det(p))<1e-16);this.q.symbols[e[t]]=new o(h.T_MATRIX,p)}}else if(this.is("{")||this.isIdent()){this.is("{")?this.parseSet():this.parseExpr();let t=this.q.stack.pop();t.type!=h.T_SET&&this.err("expected a set");let s=this.backupLexer(),i=0;for(;;){i>1e3&&this.err("constraints for random variables cannot be fulfilled"),i++;for(let s=0;s<e.length;s++){let i=this.chooseFromSet(t.value);this.q.symbols[e[s]]=new o(h.T_REAL,i)}if(this.replayLexer(s),!this.is("with"))break;{this.next(),this.parseExpr();let t=this.q.stack.pop();if(t.type!=h.T_BOOL&&this.err("constraint must be boolean"),t.value)break}}}else this.err("unexpected '"+this.tk+"'");else this.err("expected ':=' or '=' or 'in'")}parseMatrixDef(){this.terminal("MM"),this.terminal("("),this.parseExpr();let t=this.q.stack.pop();t.type===h.T_REAL&&this.isNumberInt(t.value)||this.err("expected integer for the number of rows"),t=i.round(t.value),t<=0&&this.err("number of matrix cols must be > 0 (actually is '"+t+"')"),this.terminal("x"),this.parseExpr();let e=this.q.stack.pop();e.type===h.T_REAL&&this.isNumberInt(e.value)||this.err("expected integer for the number of columns"),e=i.round(e.value),e<=0&&this.err("number of matrix rows must be > 0 (actually is '"+e+"')"),this.terminal("|"),this.parseExpr();let s=this.q.stack.pop();s.type!==h.T_SET&&this.err("expected set from which matrix elements are drawn");let r=!1,n=!1;for(;this.is(",");){this.next();let t=this.tk;switch(t){case"invertible":r=!0;break;case"symmetric":n=!0;break;default:this.err("unknown property '"+t+"'")}this.next()}this.terminal(")"),this.pushSym(h.T_MATRIX_DEF,[t,e,s,r,n])}parseSet(){this.terminal("{");let t=0,e=new o(h.T_SET);e.value=[];let s=!1;for(;!this.is("}")&&!this.is("§EOF");){t>0&&this.terminal(","),this.parseExpr();let i=this.q.stack.pop();e.value.push(i),i.type!==h.T_REAL&&(2==t&&i.type===h.T_DOTS?s=!0:i.type===h.T_COMPLEX?e.type=h.T_COMPLEX_SET:this.err("set must consist of real values only")),t++}if((s&&4!=t||s&&e.type==h.T_COMPLEX_SET)&&this.err("if set contains '...', then it must have 4 real-valued elements"),e.type==h.T_COMPLEX_SET)for(let t=0;t<e.value.length;t++)e.value[t].type==h.T_REAL&&(e.value[t].value=i.complex(e.value[t].value,0));this.q.stack.push(e),this.terminal("}")}parseSymbolicTerm(t){let e=new a(t);this.parseSymbolicTerm_Add(e),e.optimize(),this.q.stack.push(new o(h.T_FUNCTION,e))}parseSymbolicTerm_Expr(t){this.parseSymbolicTerm_Add(t)}parseSymbolicTerm_Add(t){for(this.parseSymbolicTerm_Mul(t);this.is("+")||this.is("-");){let e=this.tk;this.next(),this.parseSymbolicTerm_Mul(t),t.pushBinaryOperation(e)}}parseSymbolicTerm_Mul(t){for(this.parseSymbolicTerm_Pow(t);this.is("*")||this.is("/");){let e=this.tk;this.next(),this.parseSymbolicTerm_Pow(t),t.pushBinaryOperation(e)}}parseSymbolicTerm_Pow(t){for(this.parseSymbolicTerm_Unary(t);this.is("^");){let e=this.tk;this.next(),this.parseSymbolicTerm_Unary(t),t.pushBinaryOperation(e)}}parseSymbolicTerm_Unary(t){if(this.is("("))this.terminal("("),this.parseSymbolicTerm_Expr(t),this.terminal(")");else if(this.isNumber()){let e=parseFloat(this.tk);this.next(),this.is("!")&&(this.isNumberInt(e)||this.err("expected integer for '!'"),this.next(),e=i.factorial(e)),t.pushConstant(e)}else if(["exp","sin","cos"].includes(this.tk)){let e=this.tk;this.next(),this.terminal("("),this.parseSymbolicTerm_Expr(t),this.terminal(")"),t.pushUnaryFunction(e)}else if(this.is("diff")){this.next(),this.terminal("("),this.parseSymbolicTerm_Expr(t),this.terminal(","),this.ident();let e=this.id;this.terminal(")"),t.pushVariable(e),t.pushDiff()}else if(this.isIdent()){let e=this.tk;if(this.next(),e in this.q.symbols){let s=this.q.symbols[e];if(s.type===h.T_REAL)t.pushConstant(s.value);else if(s.type==h.T_FUNCTION)if(this.is("(")){let i=[];for(this.terminal("(");!this.is(")")&&!this.is("§EOF");){i.length>0&&this.terminal(","),this.parseExpr();let t=this.q.stack.pop();t.type!==h.T_REAL&&this.err("paremeter must be of type 'real'"),i.push(t.value)}this.terminal(")"),s.value.symbolIDs.length!=i.length&&this.err("number of parameters does not match definition of function '"+e+"'");let r={};for(let t=0;t<s.value.symbolIDs.length;t++)r[s.value.symbolIDs[t]]=i[t];t.pushConstant(s.value.eval(r))}else t.pushSymbolicTerm(s.value);else this.err("identifer '"+e+"' must be of type 'real'")}else t.pushVariable(e)}else this.is("-")?(this.next(),this.parseSymbolicTerm_Pow(t),t.pushUnaryOperation("-")):this.err("expected unary")}parseExpr(){this.parseOr()}parseOr(){if(this.parseAnd(),this.is("or")){let t=this.tk;this.next(),parseAnd();let e=this.q.stack.pop(),s=this.q.stack.pop();s.type==h.T_BOOL&&e.type==h.T_BOOL?this.pushSym(h.T_BOOL,s.value||e.value):this.err("types not compatible for '"+t+"' (must be boolean)")}}parseAnd(){if(this.parseEqual(),this.is("and")){let t=this.tk;this.next(),parseEqual();let e=this.q.stack.pop(),s=this.q.stack.pop();s.type==h.T_BOOL&&e.type==h.T_BOOL?this.pushSym(h.T_BOOL,s.value&&e.value):this.err("types not compatible for '"+t+"' (must be boolean)")}}parseEqual(){if(this.parseCompare(),this.is("==")||this.is("!=")){let t=this.tk;this.next(),this.parseCompare();let e=this.q.stack.pop(),s=this.q.stack.pop();if(s.type==h.T_REAL&&e.type==h.T_REAL){let r=i.abs(s.value-e.value)<1e-14;switch(t){case"==":this.pushSym(h.T_BOOL,r);break;case"!=":this.pushSym(h.T_BOOL,!r)}}else if(s.type==h.T_MATRIX&&e.type==h.T_MATRIX){let i=r.mat_compare_numerically(s.value,e.value);switch(t){case"==":this.pushSym(h.T_BOOL,i);break;case"!=":this.pushSym(h.T_BOOL,!i)}}else this.err("types not compatible for '"+t+"'")}}parseCompare(){if(this.parseAdd(),this.is("<=")||this.is("<")||this.is(">=")||this.is(">")){let t=this.tk;this.next(),this.parseAdd();let e=this.q.stack.pop(),s=this.q.stack.pop();if(s.type==h.T_REAL&&e.type==h.T_REAL)switch(t){case"<=":this.pushSym(h.T_BOOL,s.value<=e.value);break;case"<":this.pushSym(h.T_BOOL,s.value<e.value);break;case">=":this.pushSym(h.T_BOOL,s.value>=e.value);break;case">":this.pushSym(h.T_BOOL,s.value>e.value)}else this.err("types not compatible for '"+t+"'")}}parseAdd(){for(this.parseMul();this.is("+")||this.is("-");){let t=this.tk;this.next(),this.parseMul();let e=this.q.stack.pop(),s=this.q.stack.pop();if(s.type==h.T_REAL&&e.type==h.T_REAL)switch(t){case"+":this.pushSym(h.T_REAL,s.value+e.value);break;case"-":this.pushSym(h.T_REAL,s.value-e.value)}else if(s.type!=h.T_REAL&&s.type!=h.T_COMPLEX||e.type!=h.T_REAL&&e.type!=h.T_COMPLEX)if(s.type==h.T_MATRIX&&e.type==h.T_MATRIX){let r=s.value.size()[0],n=s.value.size()[1],a=e.value.size()[0],l=e.value.size()[1];r==a&&n==l||this.err("cannot apply '"+t+"' on ("+r+"x"+n+") and ("+a+"x"+l+") matrices"),this.pushSym(h.T_MATRIX,"+"==t?i.add(s.value,e.value):i.subtract(s.value,e.value))}else this.err("types not compatible for '"+t+"'");else switch(t){case"+":this.pushSym(h.T_COMPLEX,i.add(s.value,e.value));break;case"-":this.pushSym(h.T_COMPLEX,i.subtract(s.value,e.value))}}}parseMul(){for(this.parsePow();this.is("*")||this.is("/")||this.is("mod");){let t=this.tk;this.next(),this.parsePow();let e=this.q.stack.pop(),s=this.q.stack.pop();if(s.type==h.T_REAL&&e.type==h.T_REAL)switch(t){case"*":this.pushSym(h.T_REAL,s.value*e.value);break;case"/":this.pushSym(h.T_REAL,s.value/e.value);break;case"mod":this.isNumberInt(s.value)&&this.isNumberInt(e.value)||this.err("operator 'mod' expectes integral operands"),this.pushSym(h.T_REAL,i.mod(i.round(s.value),i.round(e.value)))}else if(s.type!=h.T_REAL&&s.type!=h.T_COMPLEX||e.type!=h.T_REAL&&e.type!=h.T_COMPLEX)if(s.type==h.T_MATRIX&&e.type==h.T_MATRIX)switch(t){case"*":let r=s.value.size()[0],n=s.value.size()[1],a=e.value.size()[0],l=e.value.size()[1];n!=a&&this.err("cannot multiply ("+r+"x"+n+") and ("+a+"x"+l+") matrices"),this.pushSym(h.T_MATRIX,i.multiply(s.value,e.value));break;case"/":case"mod":this.err("types not compatible for '"+t+"'")}else if(s.type==h.T_MATRIX&&e.type==h.T_REAL)switch(t){case"*":this.pushSym(h.T_MATRIX,i.multiply(s.value,e.value));break;case"mod":this.isNumberInt(e.value)||this.err("operator 'mod' expectes integral operands"),this.pushSym(h.T_MATRIX,r.mat_mod(s.value,e.value));break;default:console.log(s.value.toString()),this.err("types not compatible for '"+t+"'")}else if(s.type==h.T_REAL&&e.type==h.T_MATRIX)switch(t){case"*":this.pushSym(h.T_MATRIX,i.multiply(s.value,e.value));break;default:this.err("types not compatible for '"+t+"'")}else this.err("types not compatible for '"+t+"'");else switch(t){case"*":this.pushSym(h.T_COMPLEX,i.multiply(s.value,e.value));break;case"/":this.pushSym(h.T_COMPLEX,i.divide(s.value,e.value));break;case"mod":this.err("types not compatible for '"+t+"'")}}}parsePow(){for(this.parseUnary();this.is("^");){let t=this.tk;this.next(),this.parseUnary();let e=this.q.stack.pop(),s=this.q.stack.pop();if(s.type==h.T_REAL&&e.type==h.T_REAL)switch(t){case"^":this.pushSym(h.T_REAL,i.pow(s.value,e.value))}else if(s.type!=h.T_REAL&&s.type!=h.T_COMPLEX||e.type!=h.T_REAL&&e.type!=h.T_COMPLEX)if(s.type==h.T_MATRIX&&e.type==h.T_MATRIX_TRANSPOSE)switch(t){case"^":this.pushSym(h.T_MATRIX,i.transpose(s.value))}else this.err("types not compatible for '"+t+"'");else switch(t){case"^":this.pushSym(h.T_COMPLEX,i.pow(s.value,e.value))}}}parseUnary(){if(this.is("-")){this.next(),this.parseUnary();let t=this.q.stack.pop();t.type==h.T_REAL?this.pushSym(h.T_REAL,-t.value):this.err("unary '-' must be followed by type real")}else if(this.isInt()){let t=parseInt(this.tk);this.next(),this.q.stack.push(new o(h.T_REAL,t))}else if(this.is("true"))this.next(),this.q.stack.push(new o(h.T_BOOL,!0));else if(this.is("false"))this.next(),this.q.stack.push(new o(h.T_BOOL,!1));else if(this.is("i")||this.is("j"))this.q.stack.push(new o(h.T_COMPLEX,i.complex(0,1))),this.next();else if(this.is("T"))this.q.stack.push(new o(h.T_MATRIX_TRANSPOSE,"T")),this.next();else if(this.getFunctionList().includes(this.tk))this.parseFunctionCall();else if(this.isIdent()){let t=this.tk;this.next(),t in this.q.symbols==0&&this.err("unknown identifier '"+t+"'"),this.q.stack.push(this.q.symbols[t])}else this.is("...")?(this.next(),this.q.stack.push(new o(h.T_DOTS))):this.is("{")?this.parseSet():this.is("[")?this.parseMatrix():this.is("(")?(this.next(),this.parseExpr(),this.terminal(")")):this.err("expected unary, got '"+this.tk+"'");this.is("!")&&this.parseFactorial()}parseMatrix(){this.terminal("[");let t=-1,e=0,s=[];for(;this.is("[")||this.is(",");){e>0&&this.terminal(","),this.terminal("[");let i=0;for(;!this.is("]")&&!this.is("§EOF");){i>0&&this.terminal(","),this.parseExpr();let t=this.q.stack.pop();t.type!=h.T_REAL&&this.err("matrix element must be real valued"),s.push(t.value),i++}-1==t?t=i:i!=t&&this.err("matrix has different number of cols per row"),this.terminal("]"),e++}(e<1||t<1)&&this.err("matrix must have at least one row and one column"),this.terminal("]");let n=i.zeros(e,t);l(s.length==e*t);for(let i=0;i<e;i++)for(let e=0;e<t;e++)n=r.mat_set_element(n,i,e,s[i*t+e]);this.q.stack.push(new o(h.T_MATRIX,n))}isNumberInt(t){return Math.abs(t-Math.round(t))<1e-6}getFunctionList(){return["abs","binomial","integrate","conj","sqrt","xgcd","det","rank","inv","eye","eigenvalues_sym","triu","sin","cos","asin","acos","tan","atan","norm2","dot","cross","linsolve","is_zero"]}parseFunctionCall(){this.ident();let t=this.id;this.terminal("(");let e=[];for(;!this.is(")")&&!this.is("§EOL")&&!this.is("§EOF");)e.length>0&&this.terminal(","),"integrate"==t&&1==e.length?(this.ident(),e.push(this.id)):(this.parseExpr(),e.push(this.q.stack.pop()));if(this.terminal(")"),"abs"===t)(1!=e.length||e[0].type!=h.T_REAL&&e[0].type!=h.T_COMPLEX)&&this.err("signature must be 'abs(real|complex)'"),this.pushSym(h.T_REAL,i.abs(e[0].value));else if("sqrt"===t){(1!=e.length||e[0].type!=h.T_REAL&&e[0].type!=h.T_COMPLEX)&&this.err("signature must be 'sqrt(real|complex)'");let t=i.sqrt(e[0].value),s="Complex"==i.typeOf(t);this.pushSym(s?h.T_COMPLEX:h.T_REAL,t)}else if(["sin","asin","cos","acos","tan","atan"].includes(t)){1==e.length&&e[0].type==h.T_REAL||this.err("signature must be '"+t+"(real)'");let s=0;switch(t){case"sin":s=i.sin(e[0].value);break;case"asin":s=i.asin(e[0].value);break;case"cos":s=i.cos(e[0].value);break;case"acos":s=i.acos(e[0].value);break;case"tan":s=i.tan(e[0].value);break;case"atan":s=i.atan(e[0].value);break;default:this.err("UNIMPLEMENTED: "+t)}this.pushSym(h.T_REAL,s)}else if("conj"===t)1==e.length&&e[0].type==h.T_COMPLEX||this.err("signature must be 'conj(complex)'"),this.pushSym(h.T_COMPLEX,i.conj(e[0].value));else if("binomial"===t)2==e.length&&e[0].type==h.T_REAL&&e[1].type==h.T_REAL&&this.isNumberInt(e[0].value)&&this.isNumberInt(e[1].value)||this.err("signature must be 'binomial(int,int)'"),this.pushSym(h.T_REAL,i.combinations(i.round(e[0].value),i.round(e[1].value)));else if("xgcd"===t)3==e.length&&e[0].type==h.T_REAL&&e[1].type==h.T_REAL&&e[2].type==h.T_REAL&&this.isNumberInt(e[0].value)&&this.isNumberInt(e[1].value)&&this.isNumberInt(e[2].value)||this.err("signature must be 'xgcd(int,int,int)'"),this.pushSym(h.T_REAL,i.subset(i.xgcd(e[0].value,e[1].value),i.index(e[2].value-1)));else if("integrate"===t){4==e.length&&e[0].type==h.T_FUNCTION&&"string"==typeof e[1]&&e[2].type==h.T_REAL&&e[3].type==h.T_REAL||this.err("signature must be 'integrate(function, string, real, real)'");let t=e[0].value.integrateNumerically(e[1],e[2].value,e[3].value),s=.001;this.pushSym(h.T_REAL,t,s)}else if(["det","rank","inv","eigenvalues_sym","triu","norm2"].includes(t))if(1==e.length&&e[0].type==h.T_MATRIX||this.err("signature must be '"+t+"(matrix)'"),"det"===t)this.pushSym(h.T_REAL,i.det(e[0].value));else if("rank"===t)this.pushSym(h.T_REAL,r.mat_rank(e[0].value));else if("inv"===t)this.pushSym(h.T_MATRIX,i.inv(e[0].value));else if("eigenvalues_sym"===t){r.mat_is_symmetric(e[0].value)||this.err("matrix is not symmetric");let t=i.eigs(e[0].value).values._data,s=[];for(let e=0;e<t.length;e++)s.push(new o(h.T_REAL,t[e]));this.pushSym(h.T_SET,s)}else"triu"===t?this.pushSym(h.T_MATRIX,r.mat_triu(e[0].value)):"norm2"===t?this.pushSym(h.T_REAL,r.mat_norm2(e[0].value)):l(!1);else"eye"===t?(1==e.length&&e[0].type==h.T_REAL&&this.isNumberInt(e[0].value)||this.err("signature must be 'eye(integer)'"),this.pushSym(h.T_MATRIX,i.identity(i.round(e[0].value)))):"dot"===t?(2==e.length&&e[0].type==h.T_MATRIX&&e[1].type==h.T_MATRIX||this.err("signature must be 'dot(columnVector,columnVector)'"),1!=r.mat_get_col_count(e[0].value)&&this.err("signature must be 'dot(columnVector,columnVector)'"),1!=r.mat_get_col_count(e[1].value)&&this.err("signature must be 'dot(columnVector,columnVector)'"),r.mat_get_row_count(e[0].value)!=r.mat_get_row_count(e[1].value)&&this.err("vectors in 'dot(..)' must have equal length"),this.pushSym(h.T_REAL,r.mat_vecdot(e[0].value,e[1].value))):"cross"===t?(2==e.length&&e[0].type==h.T_MATRIX&&e[1].type==h.T_MATRIX||this.err("signature must be 'cross(columnVector,columnVector)'"),1!=r.mat_get_col_count(e[0].value)&&this.err("signature must be 'cross(columnVector,columnVector)'"),1!=r.mat_get_col_count(e[1].value)&&this.err("signature must be 'cross(columnVector,columnVector)'"),3!=r.mat_get_row_count(e[0].value)&&this.err("vectors in 'cross(..)' must have length 3"),3!=r.mat_get_row_count(e[1].value)&&this.err("vectors in 'cross(..)' must have length 3"),this.pushSym(h.T_MATRIX,r.mat_veccross(e[0].value,e[1].value))):"linsolve"===t?(2==e.length&&e[0].type==h.T_MATRIX&&e[1].type==h.T_MATRIX||this.err("signature must be 'linsolve(matrix,columnVector)'"),r.mat_get_col_count(e[0].value)!=r.mat_get_row_count(e[0].value)&&this.err("matrix must be square, i.e. m=n"),1!=r.mat_get_col_count(e[1].value)&&this.err("second parameter must be a colum vector"),r.mat_get_row_count(e[0].value)!=r.mat_get_row_count(e[1].value)&&this.err("number of rows of matrix and does not match vector"),this.pushSym(h.T_MATRIX,r.linsolve(e[0].value,e[1].value))):"is_zero"===t?(1==e.length&&e[0].type==h.T_MATRIX||this.err("signature must be 'is_zero(matrix)'"),this.pushSym(h.T_BOOL,r.mat_is_zero(e[0].value))):this.err("unimplemented function call '"+t+"'")}parseFactorial(){this.terminal("!");let t=this.q.stack.pop();t.type==h.T_REAL?this.pushSym(h.T_REAL,i.factorial(t.value)):this.err("types not compatible for '!'")}endItemizeIfApplicable(){this.isItemizeItem&&(this.q.html+="</li>"),this.isItemize&&(this.q.html+="</ul>"),this.isItemizeItem=!1,this.isItemize=!1}parseText(t=!1){for(this.parseWhitespaces=!0;!(this.is("§END")||this.is("§CODE_START")||t&&this.is("§EOL"));)if(1!=this.tk_col||this.is("*")||this.endItemizeIfApplicable(),this.is("§EOL")&&this.singleMultipleChoiceFeedbackHTML.length>0&&(this.q.html+="&nbsp;&nbsp;"+this.singleMultipleChoiceFeedbackHTML,this.singleMultipleChoiceFeedbackHTML="",this.q.html+="]§"),this.is("§EOL")&&this.isItemizeItem)this.next(),this.q.html+="</li>",this.isItemizeItem=!1;else if(1==this.tk_col&&this.is("["))this.parseSingleMultipleChoice(!1);else if(1==this.tk_col&&this.is("("))this.parseSingleMultipleChoice(!0);else if(1==this.tk_col&&this.is("*"))this.parseItemize();else if(this.is("`"))this.q.html+=this.parseInlineListing();else if(this.is("```"))this.q.html+=this.parseListing();else if(this.is("$"))this.parseInlineMath();else if(this.is("#"))this.q.html+=this.parseIM_Input();else if(this.isIdent()){let t=m.splitStringAndKeepDelimiters(this.tk,["__","_"]);this.next();for(let e=0;e<t.length;e++)"_"===t[e]?(this.isItalicFont=!this.isItalicFont,this.q.html+=this.isItalicFont?"<i>":"</i>"):"__"===t[e]?(this.isBoldFont=!this.isBoldFont,this.q.html+=this.isBoldFont?"<b>":"</b>"):this.q.html+=t[e]}else this.q.html+=this.charToHTML(this.tk),this.next();this.parseWhitespaces=!1,this.endItemizeIfApplicable()}parseItemize(){this.terminal("*"),0==this.isItemize&&(this.q.html+="<ul>"),this.isItemize=!0,this.isItemizeItem=!0,this.q.html+="<li>"}parseSingleMultipleChoice(t){this.parseWhitespaces=!1;let e=!1;if(t?this.terminal("("):this.terminal("["),this.is("x"))this.next(),e=!0;else if(!this.is("]")&&!this.is(")")&&!this.is(" ")){this.parseExpr();let t=this.q.stack.pop();t.type!=h.T_BOOL&&this.err("expression must be boolean"),e=t.value}t?this.terminal(")"):this.terminal("]"),this.parseWhitespaces=!0;let s=new o(h.T_BOOL,e),i=(t?"_sc_":"_mc_")+this.createUniqueID();this.q.symbols[i]=s,this.q.solutionSymbols[i]=s;let r="sell_input_"+this.instanceID+"_"+this.qidx+"_"+i,n=t?"radio":"checkbox";this.q.html+="\n§[",this.q.html+='<input id="'+r+'" type="'+n+'" name="sell_input" />&nbsp;',this.singleMultipleChoiceFeedbackHTML='&nbsp;<span id="sell_input_feedback_'+this.instanceID+"_"+this.qidx+"_"+i+'"></span>\n'}parseInlineListing(){let t="";for(this.terminal("`"),t+='<code class="text-primary">';!this.is("`")&&!this.is("§END");)t+=this.tk,this.next();return this.terminal("`"),t+="</code>",t}parseListing(){let t="";for(this.terminal("```");!this.is("```")&&!this.is("§END");)if(this.is("§EOL"))for(t+="\n",this.next();this.is(" ");)t+="&nbsp;",this.next();else this.is("\t")?(t+="&nbsp;&nbsp;&nbsp;&nbsp;",this.next()):(t+=this.tk,this.next());t=t.replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll("\n","<br/>"),this.terminal("```");let e="";return e+='<hr class="mt-2 mb-0"/>',e+='<code class="text-primary">',e+=t,e+="</code>",e+='<hr class="mt-0 mb-0"/>',e}parseInlineMath(){let t="";for(this.terminal("$"),t+=" `";!this.is("$")&&!this.is("§END");)t+=this.parseIM_Expr();t+="` ",this.terminal("$"),this.q.html+=' <span style="font-size: 13pt;">'+t.replaceAll("``","")+"</span> "}parseIM_Expr(){return this.parseIM_List()}parseIM_List(){let t=this.parseIM_Assign();for(;this.is(",")||this.is(":")||this.is("->")||this.is("|->");){let e=this.tk;this.next(),t+=" "+e+" "+this.parseIM_Assign()}return t}parseIM_Assign(){let t=this.parseIM_OtherBinaryOp();for(;this.is("=");)this.next(),t=t+" = "+this.parseIM_OtherBinaryOp();return t}parseIM_OtherBinaryOp(){let t=this.parseIM_Relational();for(;this.is("in")||this.is("notin")||this.is("uu")||this.is("^^")||this.is("vv")||this.is("@");){let e=this.tk;this.next(),t=t+" "+e+" "+this.parseIM_Relational()}return t}parseIM_Relational(){let t=this.parseIM_Add();for(;this.is("<")||this.is("<=")||this.is(">")||this.is(">=")||this.is("!=");){let e=this.tk;this.next(),t=t+" "+e+" "+this.parseIM_Add()}return t}parseIM_Add(){let t=this.parseIM_Mul();for(;this.is("+")||this.is("-");){let e=this.tk;this.next(),t=t+" "+e+" "+this.parseIM_Mul()}return t}parseIM_Mul(){let t=this.parseIM_Pow();for(;this.is("*")||this.is("/");){let e=this.tk;this.next(),t=t+" "+e+" "+this.parseIM_Pow()}return t}parseIM_Pow(){let t=this.parseIM_Unary();for(;this.is("^");){let e=this.tk;this.next(),t=t+" "+e+" "+this.parseIM_Unary()}return t}parseIM_Unary(){let t="";if(this.is("#"))t+="`"+this.parseIM_Input()+"`";else if(this.is("text")){for(this.next(),this.terminal("("),t+=" ` ";!this.is(")")&&!this.is("§EOF");)t+=this.tk,this.next();t+=" ` ",this.terminal(")")}else if(this.is("augmented")){this.next(),this.terminal("(");let e=null,s=null;this.isIdent()?(this.tk in this.q.symbols&&this.q.symbols[this.tk].type==h.T_MATRIX?e=this.q.symbols[this.tk].value:this.err("expected a matrix"),this.next()):this.err("expected a matrix"),this.terminal("|"),this.isIdent()?(this.tk in this.q.symbols&&this.q.symbols[this.tk].type==h.T_MATRIX?s=this.q.symbols[this.tk].value:this.err("expected a column vector"),this.next()):this.err("expected a column vector"),this.terminal(")");let i=r.mat_get_row_count(e),n=r.mat_get_col_count(e);1!=r.mat_get_col_count(s)&&this.err("expected a column vector"),r.mat_get_row_count(s)!=n&&this.err("matrix rows and vector rows not matching");let a="(";for(let t=0;t<i;t++){a+="(";for(let s=0;s<n;s++)a+=r.mat_get_element_value(e,t,s)+",";a+="|,"+r.mat_get_element_value(s,t,0),a+=")",t<i-1&&(a+=",")}a+=")",t+=a+" "}else if(this.is("sum")||this.is("prod")||this.is("lim")||this.is("int"))t+=" "+this.tk,this.next(),this.is("_")&&(this.next(),t+="_"+this.parseIM_Expr()),this.is("^")&&(this.next(),t+="^"+this.parseIM_Expr()),t+=" ";else if(this.is("RR")||this.is("ZZ")||this.is("QQ")||this.is("CC"))t+=this.tk+" ",this.next();else if(this.is("oo")||this.is("infty"))t+=this.tk+" ",this.next();else if(this.is("equiv")||this.is("mod"))t+=this.tk+" ",this.next();else if(this.is("EE")||this.is("AA"))t+=this.tk+" ",this.next(),t+=this.parseIM_Expr();else if(this.is("dx")||this.is("dy")||this.is("dz"))t+="\\ \\ "+this.tk,this.next();else if(this.is("bar"))t+=this.tk+" ",this.next(),t+=this.parseIM_Unary();else if(this.is("-"))this.next(),t+="-",t+=this.parseIM_Unary();else if(this.is(" "))t+=" ",this.next();else if(this.isNumber())t+=this.tk,this.next();else if(this.isIdent()){let e=this.tk;for(this.next();"_"==this.tk;)e+="_",this.next(),(this.isIdent()||this.isNumber())&&(e+=this.tk,this.next());if(e in this.q.symbols)if(this.q.symbols[e].type==h.T_MATRIX&&this.is("[")){let s=0,i=0,n=!1,a=!1;this.next(),this.is(":")?(this.next(),n=!0):this.isInt()?(s=parseInt(this.tk),this.next()):this.err("expected integer for matrix row"),this.terminal(","),this.is(":")?(this.next(),a=!0):this.isInt()?(i=parseInt(this.tk),this.next()):this.err("expected integer for matrix col"),this.terminal("]");let l=this.q.symbols[e];l.type!=h.T_MATRIX&&this.err("'"+e+"' is not a matrix");let o=n?0:s-1,p=n?-1:s-1,u=a?0:i-1,c=a?-1:i-1,m=r.mat_submatrix(l.value,o,p,u,c);null==m&&this.err("invalid indices"),t+=m.toString()}else t+=this.q.symbols[e].toAsciiMath();else t+=e}else if(this.is('"')){this.next(),this.ident();let e=this.id;for(;"_"==this.tk;)e+="_",this.next(),(this.isIdent()||this.isNumber())&&(e+=this.tk,this.next());t+=e,this.terminal('"')}else if(this.is("(")){for(this.next(),t+="(";!this.is(")")&&!this.is("§EOF");)t+=this.parseIM_Expr();this.terminal(")"),t+=")"}else if(this.is("{")){for(this.next(),t+="{ ";!this.is("}")&&!this.is("§EOF");)t+=this.parseIM_Expr();this.terminal("}"),t+=" }"}else if(this.is("|"))this.next(),t+="|";else if(this.is("\\"))this.next(),t+="\\ \\ ";else if(this.is("\\\\")||this.is("setminus"))this.next(),t+="setminus";else if(this.is("..."))this.next(),t+="... ";else if(this.is("[")&&this.is2("[")||this.is("(")&&this.is2("("))t+=this.parseIM_Matrix();else if(this.is("[")||this.is("]")){for(t+=this.tk,this.next();!this.is("]")&&!this.is("[")&&!this.is("§EOF");)t+=this.parseIM_Expr();this.is("[")||this.is("]")?(t+=this.tk,this.next()):this.err("expected '[' or ']'")}else this.err("expected unary, got '"+this.tk+"'");for(this.is("!")&&(this.next(),t+="! ");this.is("'");)this.next(),t+="'";return t}parseIM_Matrix(){let t="",e="",s="";this.is("[")&&this.is2("[")?(e="[",s="]",this.next(),t+=e):this.is("(")&&this.is2("(")?(e="(",s=")",this.next()):this.err("expected [ or (");let i=-1,r=0;for(;this.is(e)||this.is(",");){r>0&&(this.terminal(","),t+=","),this.terminal(e),t+=e;let n=0;for(;!this.is(s);)n>0&&(this.terminal(","),t+=","),t+=this.parseIM_Expr(),n++;-1==i?i=n:n!=i&&this.err("matrix has different number of cols per row"),this.terminal(s),t+=s,r++}return(r<1||i<1)&&this.err("matrix must have at least one row and one column"),this.terminal(s),t+=s,t}parseIM_Input(){let t="",e="";if(this.parseWhitespaces=!1,this.parsingInlineCode=!0,this.terminal("#"),this.is("[")){if(this.next(),this.is("diff")){for(this.next();this.is(" ");)this.next();this.isIdent()?(t=this.tk,this.next()):this.err("expected diff var")}else this.err("unknown property '"+this.tk+"'");this.terminal("]")}let s=null,i="";if(this.is('"')){this.next();let t=[],e="";for(;!this.is('"')&&!this.is("§EOF");)e+=this.tk,this.next();for(this.terminal('"'),t.push(e);this.is("|");){for(this.next(),e="",this.terminal('"');!this.is('"')&&!this.is("§EOF");)e+=this.tk,this.next();this.terminal('"'),t.push(e)}i="gap_"+this.createUniqueID(),s=new o(h.T_STRING_LIST,t),this.q.solutionSymbols[i]=s}else this.parseUnary(),i="sol"+this.createUniqueID(),s=this.q.stack.pop(),this.q.lastParsedInputSymbol=s,this.q.solutionSymbols[i]=s;this.q.solutionSymbols[i]=s,t.length>0&&(this.q.solutionSymbolsMustDiffFirst[i]=t);let n="sell_input_"+this.instanceID+"_"+this.qidx+"_"+i,a=5;switch(s.type){case h.T_STRING:case h.T_STRING_LIST:a+=10,e+=' <input type="text" value="" id="'+n+'" size="'+a+'" placeholder=""> ';break;case h.T_REAL:case h.T_FUNCTION:s.type==h.T_FUNCTION&&(a+=10),e+=' <input type="text" value="" id="'+n+'" size="'+a+'" placeholder=""> ';break;case h.T_COMPLEX:e+='<input type="text" name="sell_input" value="" id="'+n+'_real" size="'+a+'" placeholder=""> `+` ',e+='<input type="text" name="sell_input" value="" id="'+n+'_imag" size="'+a+'" placeholder=""> `i` ';break;case h.T_SET:case h.T_COMPLEX_SET:s.type==h.T_COMPLEX_SET&&(a+=5),e+="`{`";for(let t=0;t<s.value.length;t++)t>0&&(e+=" , "),e+=' <input type="text" name="sell_input" value="" id="'+n+"_"+t+'" size="'+a+'" placeholder=""> ';e+="`}`";break;case h.T_MATRIX:let t=this.resizableRows?2:r.mat_get_row_count(s.value),i=this.resizableCols?2:r.mat_get_col_count(s.value),l=new d(this.environment,this.instanceID,n,t,i,!1,this.resizableRows,this.resizableCols);this.matrixInputs.push(l),e+='<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id="'+n+'"></span>';break;default:this.err("unimplemented solution type '"+s.type+"'")}return e+='<span id="sell_input_feedback_'+this.instanceID+"_"+this.qidx+"_"+i+'"></span>',this.debug&&(e+='<span class="text-warning">'+s.toAsciiMath()+"</span>"),this.parsingInlineCode=!1,this.parseWhitespaces=!0,e}evaluateUserInput(t){let e=this.questions[t],s=!1,n=!1,o=!0;for(let s in e.solutionSymbols){let i=e.solutionSymbols[s];if(i.type==h.T_BOOL&&s.includes("_mc_")){this.getElementByIdAndType("sell_input_"+this.instanceID+"_"+t+"_"+s,this.ELEMENT_TYPE_INPUT).checked==(1==i.value)||(o=!1)}}for(let p in e.solutionSymbols){let u,c,m,d,b,v,f,y,T=e.solutionSymbols[p],k=!1,x=this.getElementByIdAndType("sell_input_feedback_"+this.instanceID+"_"+t+"_"+p,this.ELEMENT_TYPE_SPAN),g="",I=!0;switch(0==o&&(I=!1),T.type){case h.T_STRING_LIST:u=this.getElementByIdAndType("sell_input_"+this.instanceID+"_"+t+"_"+p,this.ELEMENT_TYPE_INPUT).value;for(let t=0;t<T.value.length;t++){let e=T.value[t],s=_(u,e);if(s=i.abs(s),k=e.length<=3?0==s:s<=2,g=e.length>3&&s>0&&s<=2?'<span class="text-warning">'+e+"</span>":"",k)break}break;case h.T_BOOL:u=this.getElementByIdAndType("sell_input_"+this.instanceID+"_"+t+"_"+p,this.ELEMENT_TYPE_INPUT).checked,p.includes("_sc_")&&(s=!0,u||(I=!1),u&&(n=!0)),u==(1==T.value)&&(k=!0);break;case h.T_REAL:u=this.getElementByIdAndType("sell_input_"+this.instanceID+"_"+t+"_"+p,this.ELEMENT_TYPE_INPUT).value,u=u.replace(",",".");try{u=i.evaluate(u)}catch(t){switch(this.language){case"en":g+='Syntax error in "'+u+'".&nbsp;&nbsp;';break;case"de":g+='Syntaxfehler in "'+u+'".&nbsp;&nbsp;'}u=0}i.abs(T.value-u)<T.precision&&(k=!0),T.user_value=u;break;case h.T_COMPLEX:let o=this.getElementByIdAndType("sell_input_"+this.instanceID+"_"+t+"_"+p+"_real",this.ELEMENT_TYPE_INPUT),E=this.getElementByIdAndType("sell_input_"+this.instanceID+"_"+t+"_"+p+"_imag",this.ELEMENT_TYPE_INPUT);if(d=o.value,b=E.value,d.includes("sin")||d.includes("cos")){let t="";switch(this.language){case"en":t="sin(..) and cos(..) not allowed here!";break;case"de":t="sin(..) und cos(..) sind nicht erlaubt!"}return void(x.innerHTML='<span class="text-danger">&nbsp;&nbsp;'+t+"</span>")}0==d.length&&(o.value="0",d=0),0==b.length&&(E.value="0",b=0);try{d=i.evaluate(d)}catch(t){switch(this.language){case"en":g+='Syntax error in "'+d+'".&nbsp;&nbsp;';break;case"de":g+='Syntaxfehler in "'+d+'".&nbsp;&nbsp;'}d=0}try{b=i.evaluate(b)}catch(t){switch(this.language){case"en":g+='Syntax error in "'+b+'".&nbsp;&nbsp;';break;case"de":g+='Syntaxfehler in "'+b+'".&nbsp;&nbsp;'}b=0}m=i.complex(parseFloat(d),parseFloat(b)),diff=i.abs(i.subtract(T.value,m)),diff<1e-9&&(k=!0);break;case h.T_SET:case h.T_COMPLEX_SET:u=[],y=T.value.length;for(let e=0;e<y;e++){let s=this.getElementByIdAndType("sell_input_"+this.instanceID+"_"+t+"_"+p+"_"+e,this.ELEMENT_TYPE_INPUT),r=s.value;r=r.replace("j","i"),r=r.replace(",","."),0==r.length&&(s.value="0",r="0");try{r=i.evaluate(r)}catch(t){switch(sellLanguage){case"en":g+='Syntax error in "'+r+'".&nbsp;&nbsp;';break;case"de":g+='Syntaxfehler in "'+r+'".&nbsp;&nbsp;'}r="0"}u.push(r)}let S=0;for(let t=0;t<y;t++){let e=T.value[t].value;for(let t=0;t<y;t++){let s=u[t];if(i.abs(i.subtract(e,s))<1e-9){S++;break}}}if(S<y)switch(this.language){case"en":g+=S+" out of "+y+" answers are correct";break;case"de":g+=S+" von "+y+" Antworten sind korrekt"}else k=!0;break;case h.T_FUNCTION:if(c=this.getElementByIdAndType("sell_input_"+this.instanceID+"_"+t+"_"+p,this.ELEMENT_TYPE_INPUT),u=c.value,0==u.length&&(u="11111111"),u=u.replace(",","."),p in e.solutionSymbolsMustDiffFirst){let t=new a;if(t.importMathJsTerm(u)){let s=e.solutionSymbolsMustDiffFirst[p];u=t.derivate(s),u=u.toString(),k=T.value.compareWithStringTerm(u)}else k=!1}else k=T.value.compareWithStringTerm(u);if(!k&&"syntaxerror"==T.value.state)switch(this.language){case"en":g+='Syntax errors or invalid variables in "'+u+'"';break;case"de":g+='Syntaxfehler oder unzulässige Variablen in "'+u+'"'}T.user_value=u;break;case h.T_MATRIX:v=null;for(let e=0;e<this.matrixInputs.length;e++)if(this.matrixInputs[e].id==="sell_input_"+this.instanceID+"_"+t+"_"+p){v=this.matrixInputs[e];break}if(f=i.size(T.value).subset(i.index(0)),y=i.size(T.value).subset(i.index(1)),v.setUnsetElementsToZero(),v.m==f&&v.n==y){k=!0;let t=i.zeros(f,y);for(let e=0;e<f;e++)for(let s=0;s<y;s++){let r,n=v.getElementText(e,s);try{r=i.evaluate(n)}catch(t){switch(this.language){case"en":g+='Syntax error in "'+n+'".&nbsp;&nbsp;';break;case"de":g+='Syntaxfehler in "'+n+'".&nbsp;&nbsp;'}r=0,k=!1}t=t.subset(i.index(e,s),r)}k&&(k=r.mat_compare_numerically(T.value,t))}else switch(this.language){case"en":g+="Dimensioned incorrectly!";break;case"de":g+="Falsche Dimensionierung!"}break;default:l(!1,"evaluateUserInput: solution type '"+T.type+"' is unimplemented")}I?k?x.innerHTML="&#x2705; &nbsp;&nbsp; "+g:(x.innerHTML='&#x274C; &nbsp;&nbsp; <span class="text-danger">'+g+"</span>",T.hint_html.length>0&&(x.innerHTML+='  <span class="text-info">'+T.hint_html+"</span>",setTimeout((function(){MathJax.typeset()}),10))):x.innerHTML=""}let p=this.getElementByIdAndType("sell_input_feedback_"+this.instanceID+"_"+t+"_general_feedback",this.ELEMENT_TYPE_SPAN);if(s&&!n)switch(this.language){case"en":p.innerHTML='<span class="text-danger">No answer chosen!</span>';break;case"de":p.innerHTML='<span class="text-danger">Keine Antwort gewählt!</span>'}else if(o)p.innerHTML="";else switch(this.language){case"en":p.innerHTML='<span class="text-danger">Not yet correct. Try again!</span>';break;case"de":p.innerHTML='<span class="text-danger">Noch nicht korrekt. Nochmal versuchen!</span>'}}},Object.defineProperty(t,"__esModule",{value:!0}),t}({},math);
