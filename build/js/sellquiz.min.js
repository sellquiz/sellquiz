var sellquiz=function(t,e){"use strict";function s(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(s){if("default"!==s){var i=Object.getOwnPropertyDescriptor(t,s);Object.defineProperty(e,s,i.get?i:{enumerable:!0,get:function(){return t[s]}})}})),e.default=t,Object.freeze(e)}var i,l=s(e);function r(t,e=""){t||(console.log(e),"undefined"!=typeof process?process.exit(-1):alert(e))}!function(t){t.T_UNKNOWN="T_UNKNOWN",t.T_REAL="T_REAL",t.T_DOTS="T_DOTS",t.T_SET="T_SET",t.T_BOOL="T_BOOL",t.T_FUNCTION="T_FUNCTION",t.T_COMPLEX="T_COMPLEX",t.T_COMPLEX_SET="T_COMPLEX_SET",t.T_MATRIX="T_MATRIX",t.T_MATRIX_DEF="T_MATRIX_DEF",t.T_MATRIX_TRANSPOSE="T_MATRIX_TRANSPOSE",t.T_MATRIX_OF_FUNCTIONS="T_MATRIX_OF_FUNCTIONS",t.T_STRING="T_STRING",t.T_STRING_LIST="T_STRING_LIST"}(i||(i={}));class n{constructor(t=i.T_UNKNOWN,e=null,s=1e-9){this.hint_html="",this.type=t,this.value=e,this.precision=s}exportDictionary(t){let e={};return e.id=t,e.type=this.type,e.value=this.value.toString(),e.precision=this.precision,e.hint=this.hint_html,e}importDictionary(t){switch(this.type=i[t.type],this.type){case i.T_REAL:this.value=parseFloat(t.value);break;default:r(!1,"SellSymbol:importFromDictionary(): UNIMPLMENTED")}this.precision=t.precision,this.hint_html=t.hint}toAsciiMath(){let t="";switch(this.type){case i.T_BOOL:return this.value?"true":"false";case i.T_UNKNOWN:return"ERROR";case i.T_REAL:return this.value;case i.T_DOTS:return"...";case i.T_SET:case i.T_COMPLEX_SET:t="{ ";for(let e=0;e<this.value.length;e++)t+=(e>0?", ":"")+this.value[e].toAsciiMath();return t+=" }",t;case i.T_FUNCTION:case i.T_COMPLEX:return t=this.value.toString(),t;case i.T_MATRIX:case i.T_MATRIX_OF_FUNCTIONS:return t=this.value.toString(),t=t.replaceAll("[","("),t=t.replaceAll("]",")"),t;default:r(!1,"unimplemented SellSymbol::toAsciiMath(..)")}}}class a{constructor(t,e,s){this.str=t,this.line=e,this.col=s}}class p{static isAlpha(t){return t>="A"&&t<="Z"||t>="a"&&t<="z"||"_"==t||"Ä"==t||"Ö"==t||"Ü"==t||"ß"==t||"ä"==t||"ö"==t||"ü"==t}static isNum(t){return t>="1"&&t<="9"}static isNum0(t){return"0"==t||this.isNum(t)}static isIdentifier(t){for(let e=0;e<t.length;e++){let s=t[e];if(0==e){if(0==this.isAlpha(s))return!1}else if(0==this.isAlpha(s)&&0==this.isNum0(s))return!1}return!0}static isInteger(t){if(0==t.length)return!1;let e=0;if("-"===t[0]&&(e=1,1==t.length))return!1;for(let s=e;s<t.length;s++){let e=t[s];if(0==this.isNum0(e))return!1}return!0}static isReal(t){return 0==isNaN(parseFloat(t))}static tokenize(t){let e=new Array,s="",i=1,l=1,r=1,n=!t.startsWith("\t")&&!t.startsWith("    ");for(let p=0;p<t.length;p++){let h=t[p],o="";p<t.length-1&&(o=t[p+1]);let u="";switch(p<t.length-2&&(u=t[p+2]),h){case" ":case"\t":case"\n":s.length>0&&e.push(new a(s,l,i)),s="",i=r,"\n"===h?(l++,r=0):" "===h&&e.push(new a(h,l,i));break;case"_":n?(s.length>0&&e.push(new a(s,l,i)),s="",i=r,"_"==h&&"_"==o&&(h="__",p++),e.push(new a(h,l,i)),i=r):(0==s.length&&(i=r),s+=h);break;case"(":case")":case"{":case"}":case"[":case"]":case"+":case"-":case"*":case"/":case"^":case"~":case"#":case".":case",":case";":case":":case"=":case"@":case"|":case"$":case"?":case"!":case'"':case"<":case">":case"`":case"\\":case"'":s.length>0&&e.push(new a(s,l,i)),s="",i=r,":"==h&&"="==o?(h=":=",p++):"^"==h&&"^"==o?(h="^^",p++):"\\"==h&&"\\"==o?(h="\\\\",p++):"-"==h&&">"==o?(h="->",p++):"|"==h&&"-"==o&&">"==u?(h="|->",p+=2):"<"==h&&"="==o?(h="<=",p++):">"==h&&"="==o?(h=">=",p++):"="==h&&"="==o?(h="==",p++):"!"==h&&"="==o?(h="!=",p++):"."==h&&"."==o&&"."==u?(h="...",p+=2):"`"==h&&"`"==o&&"`"==u&&(h="```",p+=2),e.push(new a(h,l,i)),i=r;break;default:0==s.length&&(i=r),s+=h}r++}return s.length>0&&e.push(new a(s,l,i)),e}static printTokenList(t){for(let e=0;e<t.length;e++){let s=t[e];console.log(s.line+":"+s.col+":"+s.str)}}static randomInt(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t)+t)}static splitStringAndKeepDelimiters(t,e){let s=Array(),i="";for(let l=0;l<t.length;l++){let r=!0,n="";for(let s=0;s<e.length;s++){let i=e[s];if(r=!0,l+i.length>t.length)r=!1;else for(let e=0;e<i.length;e++)if(t[l+e]!=i[e]){r=!1;break}if(r){n=i;break}}r?(i.length>0&&(s.push(i),i=""),s.push(n),l+=n.length-1):i+=t[l]}return i.length>0&&s.push(i),s}}class h{constructor(t){this.p=t}parseTitle(){this.p.parseWhitespaces=!0;let t="";for(;!this.p.is("§EOL")&&!this.p.is("§END");)this.p.isIdent()?(t+=this.p.tk,this.p.next()):this.p.is("#")?(this.p.next(),this.p.isIdent()?(this.p.tk,this.p.next()):this.p.err("expected identifer after '#'")):(t+=this.p.charToHTML(this.p.tk),this.p.next());this.p.terminal("§EOL"),this.p.parseWhitespaces=!1,this.p.q.titleHtml=t}endItemizeIfApplicable(){this.p.isItemizeItem&&(this.p.q.html+="</li>"),this.p.isItemize&&(this.p.q.html+="</ul>"),this.p.isItemizeItem=!1,this.p.isItemize=!1}parseText(t=!1){for(this.p.parseWhitespaces=!0;!(this.p.is("§END")||this.p.is("§CODE_START")||t&&this.p.is("§EOL"));)if(1!=this.p.tk_col||this.p.is("*")||this.endItemizeIfApplicable(),this.p.is("§EOL")&&this.p.singleMultipleChoiceFeedbackHTML.length>0&&(this.p.q.html+="&nbsp;&nbsp;"+this.p.singleMultipleChoiceFeedbackHTML,this.p.singleMultipleChoiceFeedbackHTML="",this.p.q.html+="]§"),this.p.is("§EOL")&&this.p.isItemizeItem)this.p.next(),this.p.q.html+="</li>",this.p.isItemizeItem=!1;else if(1==this.p.tk_col&&this.p.is("["))this.parseSingleMultipleChoice(!1);else if(1==this.p.tk_col&&this.p.is("("))this.parseSingleMultipleChoice(!0);else if(1==this.p.tk_col&&this.p.is("*"))this.parseItemize();else if(this.p.is("`"))this.p.q.html+=this.parseInlineListing();else if(this.p.is("```"))this.p.q.html+=this.parseListing();else if(this.p.is("$"))this.p.imParser.parseInlineMath();else if(this.p.is("#"))this.p.q.html+=this.p.imInputParser.parseIM_Input();else if(this.p.isIdent()){let t=p.splitStringAndKeepDelimiters(this.p.tk,["__","_"]);this.p.next();for(let e=0;e<t.length;e++)"_"===t[e]?(this.p.isItalicFont=!this.p.isItalicFont,this.p.q.html+=this.p.isItalicFont?"<i>":"</i>"):"__"===t[e]?(this.p.isBoldFont=!this.p.isBoldFont,this.p.q.html+=this.p.isBoldFont?"<b>":"</b>"):this.p.q.html+=t[e]}else this.p.q.html+=this.p.charToHTML(this.p.tk),this.p.next();this.p.parseWhitespaces=!1,this.endItemizeIfApplicable()}parseItemize(){this.p.terminal("*"),0==this.p.isItemize&&(this.p.q.html+="<ul>"),this.p.isItemize=!0,this.p.isItemizeItem=!0,this.p.q.html+="<li>"}parseSingleMultipleChoice(t){this.p.parseWhitespaces=!1;let e=!1;if(t?this.p.terminal("("):this.p.terminal("["),this.p.is("x"))this.p.next(),e=!0;else if(!this.p.is("]")&&!this.p.is(")")&&!this.p.is(" ")){this.p.codeParser.parseExpr();let t=this.p.q.stack.pop();t.type!=i.T_BOOL&&this.p.err("expression must be boolean"),e=t.value}t?this.p.terminal(")"):this.p.terminal("]"),this.p.parseWhitespaces=!0;let s=t?"_sc_":"_mc_",l=new n(i.T_BOOL,e),r=s+this.p.createUniqueID();this.p.q.symbols[r]=l,this.p.q.solutionSymbols[r]=l;let a=new S;a.htmlElementId="sellquiz_input_"+r,a.solutionVariableId=r,a.htmlElementId_feedback="sellquiz_feedback_"+r,a.htmlElementInputType=A.CHECKBOX,this.p.q.inputs.push(a);let p=t?"radio":"checkbox";this.p.q.html+="\n§[",this.p.q.html+='<input id="'+a.htmlElementId+'" type="'+p+'" name="sell_input" />&nbsp;',this.p.singleMultipleChoiceFeedbackHTML='&nbsp;<span id="'+a.htmlElementId_feedback+'"></span>\n'}parseInlineListing(){let t="";for(this.p.terminal("`"),t+='<code class="text-primary">';!this.p.is("`")&&!this.p.is("§END");)t+=this.p.tk,this.p.next();return this.p.terminal("`"),t+="</code>",t}parseListing(){let t="";for(this.p.terminal("```");!this.p.is("```")&&!this.p.is("§END");)if(this.p.is("§EOL"))for(t+="\n",this.p.next();this.p.is(" ");)t+="&nbsp;",this.p.next();else this.p.is("\t")?(t+="&nbsp;&nbsp;&nbsp;&nbsp;",this.p.next()):(t+=this.p.tk,this.p.next());t=t.replaceAll("<","&lt;"),t=t.replaceAll(">","&gt;"),t=t.replaceAll("\n","<br/>"),this.p.terminal("```");let e="";return e+='<hr class="mt-2 mb-0"/>',e+='<code class="text-primary">',e+=t,e+="</code>",e+='<hr class="mt-0 mb-0"/>',e}}class o{static mat_idx(t,e,s,i){return s*e+i}static mat_get_row_count(t){return t.size()[0]}static mat_get_col_count(t){return t.size()[1]}static mat_get_element_value(t,e,s){return t.subset(l.index(e,s))}static mat_submatrix(t,e,s,i,r){let n=t.size()[0],a=t.size()[1];if(-1==s&&(s=n-1),-1==r&&(r=a-1),e>s||i>r)return null;if(e<0||i<0||e>=n||i>=a)return null;if(s<0||r<0||s>=n||r>=a)return null;let p=s-e+1,h=r-i+1,o=l.zeros(p,h);for(let n=e;n<=s;n++)for(let s=i;s<=r;s++){let r=t.subset(l.index(n,s));o=this.mat_set_element(o,n-e,s-i,r)}return o}static mat_rank(t){let e=t.size()[0],s=t.size()[1],i=[];for(let r=0;r<e;r++)for(let e=0;e<s;e++)i.push(t.subset(l.index(r,e)));let r=0,n=[];for(let t=0;t<s;t++)n.push(!1);for(let t=0;t<e;t++){let l;for(l=0;l<s&&(n[l]||!(Math.abs(i[this.mat_idx(e,s,t,l)])>1e-12));l++);if(l!=s){r++,n[l]=!0;for(let r=t+1;r<e;r++)i[this.mat_idx(e,s,r,l)]/=i[this.mat_idx(e,s,t,l)];for(let r=0;r<s;r++)if(r!=l&&Math.abs(i[this.mat_idx(e,s,t,r)])>1e-12)for(let n=t+1;n<e;n++)i[this.mat_idx(e,s,n,r)]-=i[this.mat_idx(e,s,n,l)]*i[this.mat_idx(e,s,t,r)]}}return r}static mat_is_symmetric(t){let e=t.size()[0],s=t.size()[1];if(e!=s)return!1;for(let e=0;e<s;e++)for(let i=e+1;i<s;i++){let s=t.subset(l.index(e,i)),r=t.subset(l.index(i,e));if(l.abs(s-r)>1e-14)return!1}return!0}static mat_triu(t){let e=t.size()[0],s=t.size()[1],i=l.zeros(e,s);for(let r=0;r<e;r++)for(let e=0;e<s;e++){let s=t.subset(l.index(r,e));e<r&&(s=0),i=i.subset(l.index(r,e),s)}return i}static mat_norm2(t){let e=t.size()[0],s=t.size()[1],i=0;for(let r=0;r<e;r++)for(let e=0;e<s;e++){let s=t.subset(l.index(r,e));i+=s*s}return l.sqrt(i)}static mat_vecdot(t,e){let s=t.size()[0],i=t.size()[1],n=e.size()[0],a=e.size()[1];1==i&&1==a&&s==n||r(!1,"mat_vecdot(..): invalid input");let p=0;for(let i=0;i<s;i++)p+=t.subset(l.index(i,0))*e.subset(l.index(i,0));return p}static mat_veccross(t,e){let s=t.size()[0],i=t.size()[1],n=e.size()[0],a=e.size()[1];1==i&&1==a&&3==s&&3==n||r(!1,"mat_veccross(..): invalid input");let p=this.mat_get_element_value(t,0,0),h=this.mat_get_element_value(t,1,0),o=this.mat_get_element_value(t,2,0),u=this.mat_get_element_value(e,0,0),c=this.mat_get_element_value(e,1,0),m=this.mat_get_element_value(e,2,0),d=l.zeros(3,1);return d=d.subset(l.index(0,0),h*m-o*c),d=d.subset(l.index(1,0),o*u-p*m),d=d.subset(l.index(2,0),p*c-h*u),d}static mat_is_row_zero(t,e,s,i){for(let l=0;l<s;l++)if(Math.abs(t[this.mat_idx(e,s,i,l)])>1e-12)return!1;return!0}static mat_is_zero(t){let e=t.size()[0],s=t.size()[1];for(let i=0;i<e;i++)for(let e=0;e<s;e++){let s=t.subset(l.index(i,e));if(Math.abs(s)>1e-12)return!1}return!0}static linsolve(t,e){return t.size()[0],t.size()[1],l.lusolve(t.clone(),e.clone())}static mat_kernel(t){let e,s=l.lup(t).U,i=s.size()[0],r=s.size()[1],n=[];for(let t=0;t<i;t++)for(let e=0;e<r;e++)n.push(s.subset(l.index(t,e)));for(e=0;e<i&&!this.mat_is_row_zero(n,i,r,e);e++);for(let t=e-1;t>=1;t--)for(let e=t-1;e>=0;e--){let s=n[this.mat_idx(i,r,e,t)]/n[this.mat_idx(i,r,t,t)];for(let l=0;l<r;l++)n[this.mat_idx(i,r,e,l)]-=s*n[this.mat_idx(i,r,t,l)]}for(let t=0;t<e;t++){let e=n[this.mat_idx(i,r,t,t)];for(let s=0;s<r;s++)n[this.mat_idx(i,r,t,s)]/=e}let a=r,p=r-e,h=[];for(let t=0;t<a*p;t++)h.push(0);for(let t=0;t<p;t++)h[this.mat_idx(a,p,a-1-t,p-1-t)]=-1;for(let t=0;t<e;t++)for(let s=0;s<p;s++)h[this.mat_idx(a,p,t,s)]=n[this.mat_idx(i,r,t,s+e)];let o=l.zeros(a,p);for(let t=0;t<a;t++)for(let e=0;e<p;e++)o=o.subset(l.index(t,e),h[this.mat_idx(a,p,t,e)]);return h}static mat_set_element(t,e,s,i){let r=t.size()[0],n=t.size()[1];return e<0||e>=r||s<0||s>=n?null:t=t.subset(l.index(e,s),i)}static mat_mod(t,e){let s=t.size()[0],i=t.size()[1],r=l.zeros(s,i);for(let n=0;n<s;n++)for(let s=0;s<i;s++){let i=Math.round(t.subset(l.index(n,s)));i=l.mod(i,e),r=r.subset(l.index(n,s),i)}return r}static mat_compare_numerically(t,e){let s=t.size()[0],i=t.size()[1],r=e.size()[0],n=e.size()[1];if(s!=r&&i!=n)return!1;for(let r=0;r<s;r++)for(let s=0;s<i;s++){let i=t.subset(l.index(r,s)),n=e.subset(l.index(r,s));if(Math.abs(i-n)>1e-12)return!1}return!0}static mat_compare_numerically_except_scaling_factor(t,e){const s=1e-12;let i=t.size()[0],r=t.size()[1],n=e.size()[0],a=e.size()[1];if(i!=n&&r!=a)return!1;let p=!0,h=1;for(let n=0;n<i;n++)for(let i=0;i<r;i++){let r=t.subset(l.index(n,i)),a=e.subset(l.index(n,i));if(Math.abs(r*h-a)>s){if(!p)return!1;if(p=!1,Math.abs(r)<s||Math.abs(a)<s)return!1;h=a/r}}return!0}}class u{constructor(t,e){this.type=t,this.v=e,this.deriv=null}}class c{constructor(t=[]){this.symbolIDs=t,this.stack=[],this.state="",this.contains_forbidden_ode_subtree=!1}clear(){this.stack=[]}importTerm(t){let e=l.parse(t);return this.importMathJsTermJsRecursively(e)}importMathJsTermJsRecursively(t){switch(t.type){case"ConstantNode":this.pushConstant(t.value);break;case"SymbolNode":this.pushVariable(t.name);break;case"OperatorNode":case"ParenthesisNode":for(;"ParenthesisNode"==t.type;)t=t.content;if("unaryMinus"==t.fn){if(0==this.importMathJsTermJsRecursively(t.args[0]))return!1;this.pushUnaryOperation("-")}else{if("+"!=t.op&&"-"!=t.op&&"*"!=t.op&&"/"!=t.op&&"^"!=t.op)return console.log("warning: SellSymTerm::importMathJsTermJsRecursively(..): unknown/unimplemented operation "+t.op),!1;if(0==this.importMathJsTermJsRecursively(t.args[0]))return!1;if(0==this.importMathJsTermJsRecursively(t.args[1]))return!1;this.pushBinaryOperation(t.op)}break;case"FunctionNode":if("exp"!=t.name&&"sin"!=t.name&&"cos"!=t.name&&"sqrt"!=t.name)return console.log("warning: SellSymTerm::importMathJsTermJsRecursively(..): unknown/unimplemented function "+t.name),!1;if(0==this.importMathJsTermJsRecursively(t.args[0]))return!1;this.pushUnaryFunction(t.name);break;default:return console.log("warning: SellSymTerm::importMathJsTermJsRecursively(..): unknown/unimplemented node type "+t.type),!1}return!0}pushVariable(t){this.stack.push(new u("var",t))}pushOdeFunction(t){this.stack.push(new u("ode_fun",t))}pushConstant(t){t=parseFloat(t),this.stack.push(new u("const",t))}pushSymbolicTerm(t){0==t.stack.length?this.stack.push(new u("const",0)):this.stack.push(t.stack[0])}pushUnaryFunction(t){let e=this.stack.pop();this.stack.push(new u("fct1",[t,e]))}pushBinaryFunction(t){let e=this.stack.pop(),s=this.stack.pop();this.stack.push(new u("fct2",[t,s,e]))}pushDiff(){let t=this.stack.pop(),e=this.stack.pop(),s=new c;s.symbolIDs=this.symbolIDs,s.stack.push(e);let i=s.derivate(t.v);this.pushSymbolicTerm(i)}pushUnaryOperation(t){let e=this.stack.pop();this.stack.push(new u("uniop",[t,e]))}pushBinaryOperation(t){t=t.replace("add","+").replace("sub","-").replace("mul","*").replace("div","/").replace("pow","^");let e=this.stack.pop(),s=this.stack.pop();if("const"==s.type&&"const"==e.type){let i;switch(i=0,t){case"+":i=s.v+e.v;break;case"-":i=s.v-e.v;break;case"*":i=s.v*e.v;break;case"/":i=s.v/e.v;break;case"^":i=l.pow(s.v,e.v);break;default:alert("unimplemented: SellSymTerm:pushBinaryOperation(..): operator "+t)}this.stack.push(new u("const",i))}else this.stack.push(new u("binop",[t,s,e]))}appendVariableSet(t,e){for(let s=0;s<e.length;s++){let i=!1;for(let l=0;l<t.length;l++)if(e[s]===t[l]){i=!0;break}0==i&&t.push(e[s])}}getVariables(t=null){let e,s,i=[];switch(null==t&&(t=this.stack[0]),t.type){case"var":this.appendVariableSet(i,[t.v]);break;case"const":break;case"uniop":e=this.getVariables(t.v[1]),this.appendVariableSet(i,e);break;case"binop":e=this.getVariables(t.v[1]),this.appendVariableSet(i,e),s=this.getVariables(t.v[2]),this.appendVariableSet(i,s);break;case"ode_fun":this.appendVariableSet(i,[t.v]);break;case"fct1":e=this.getVariables(t.v[1]),this.appendVariableSet(i,e);break;case"fct2":e=this.getVariables(t.v[1]),this.appendVariableSet(i,e),s=this.getVariables(t.v[2]),this.appendVariableSet(i,s);break;default:alert("unimplemented: SellSymTerm:getVariables(..): "+t.type)}return i}getOdeOrder(t=null){let e=0;switch(null==t&&(t=this.stack[0]),t.type){case"uniop":e=l.max(e,this.getOdeOrder(t.v[1]));break;case"binop":e=l.max(e,this.getOdeOrder(t.v[1])),e=l.max(e,this.getOdeOrder(t.v[2]));break;case"fct2":"diff_ode"==t.v[0]?e=l.max(e,1):"diff2_ode"==t.v[0]&&(e=l.max(e,2))}return e}optimizeOdeConstants(t=null){let e,s,i;switch(null==t&&(t=this.stack[0]),t.type){case"var":break;case"uniop":this.optimizeOdeConstants(t.v[1]),e=t.v[1],"var"===e.type&&e.v.startsWith("C")&&(t.type="var",t.v=e.v);break;case"binop":this.optimizeOdeConstants(t.v[1]),this.optimizeOdeConstants(t.v[2]),s=t.v[1],i=t.v[2],"var"===s.type&&s.v.startsWith("C")&&"const"===i.type?(t.type="var",t.v=s.v):"var"===i.type&&i.v.startsWith("C")&&"const"===s.type&&(t.type="var",t.v=i.v);break;case"fct1":this.optimizeOdeConstants(t.v[1]),e=t.v[1],"var"===e.type&&e.v.startsWith("C")&&(t.type="var",t.v=e.v)}}searchForForbiddenODESecondOrderSubterms(t=null){let e,s,i=[];switch(null==t&&(t=this.stack[0]),t.type){case"var":this.appendVariableSet(i,[t.v]);break;case"const":break;case"uniop":e=this.searchForForbiddenODESecondOrderSubterms(t.v[1]),this.appendVariableSet(i,e);break;case"binop":e=this.searchForForbiddenODESecondOrderSubterms(t.v[1]),this.appendVariableSet(i,e),s=this.searchForForbiddenODESecondOrderSubterms(t.v[2]),this.appendVariableSet(i,s);break;case"ode_fun":this.appendVariableSet(i,[t.v]);break;case"fct1":e=this.searchForForbiddenODESecondOrderSubterms(t.v[1]),this.appendVariableSet(i,e);break;case"fct2":e=this.searchForForbiddenODESecondOrderSubterms(t.v[1]),this.appendVariableSet(i,e),s=this.searchForForbiddenODESecondOrderSubterms(t.v[2]),this.appendVariableSet(i,s);break;default:alert("unimplemented: SellSymTerm:searchForForbiddenODESecondOrderSubterms(..): "+t.type)}if(console.log("TEST:"),console.log(i),2==i.length){this.contains_forbidden_ode_subtree=!0;for(let t=0;t<i.length;t++)0==i[t].startsWith("C")&&(this.contains_forbidden_ode_subtree=!1)}return i}getOperator(t){let e="";return"uniop"!=t.type&&"binop"!=t.type||(e=t.v[0]),e}getOperatorPrecedence(t){let e=0;switch(t){case"+":case"-":e=10;break;case"*":case"/":e=20;break;case"^":e=30;break;case"":e=99;break;default:alert("unimplemented: SellSymTerm:getOperatorPrecedence(..): op="+t)}return e}toString(t=null){let e,s,i,r,n="",a=!1;switch(null==t&&(a=!0,t=this.stack[0]),t.type){case"var":n=t.v;break;case"const":n=t.v.toString(),l.abs(t.v-3.141592653589793)<1e-12&&(n="pi");break;case"uniop":n=t.v[0]+this.toString(t.v[1]),"uniop"==t.v[1].type&&(n="("+n+")");break;case"ode_fun":n=t.v.id+"("+t.v.mathsymbol_ids[0]+")";break;case"binop":let a=this.toString(t.v[1]),p=this.toString(t.v[2]),h=t.v[0],o=this.getOperatorPrecedence(h),u=this.getOperator(t.v[1]),c=this.getOperatorPrecedence(u),m=this.getOperator(t.v[2]),d=this.getOperatorPrecedence(m);(c<o||"/"===h)&&(a="("+a+")"),d<o||p.startsWith("-")?p="("+p+")":"-"!==h&&"/"!==h||"const"!==t.v[2].type&&(p="("+p+")"),n=a+h+p;break;case"fct1":e=t.v[0],s=this.toString(t.v[1]),n="exp"===e&&s.length<5?"e^("+s+")":e+"("+s+")";break;case"fct2":e=t.v[0],"diff_ode"===e?n=t.v[1].v.id+"'("+t.v[2].v+")":"diff2_ode"===e?n=t.v[1].v.id+"''("+t.v[2].v+")":(i=this.toString(t.v[1]),r=this.toString(t.v[2]),n=e+"("+i+", "+r+")");break;default:alert("unimplemented: SellSymTerm:toString(..): "+t.type)}return a&&n.startsWith("(")&&(n=n),n}derivate(t,e=null){let s,i,l,r,n,a=null==e;switch(a&&(e=this.stack[0]),e.type){case"var":e.deriv=new u("const",e.v==t?1:0);break;case"const":e.deriv=new u("const",0);break;case"uniop":switch(s=e.v[1],this.derivate(t,s),l=e.v[0],l){case"-":e.deriv=new u("uniop",[l,s.deriv]);break;default:alert("unimplemented: SellSymTerm:derivate(..): uniop: "+l)}break;case"binop":switch(s=e.v[1],this.derivate(t,s),i=e.v[2],this.derivate(t,i),l=e.v[0],l){case"+":case"-":e.deriv=new u("binop",[l,s.deriv,i.deriv]);break;case"*":e.deriv=new u("binop",["+",new u("binop",["*",s.deriv,i]),new u("binop",["*",i.deriv,s])]);break;case"/":e.deriv=new u("binop",["/",new u("binop",["-",new u("binop",["*",s.deriv,i]),new u("binop",["*",i.deriv,s])]),new u("binop",["*",i,i])]);break;case"^":"const"!==i.type&&alert("unimplemented: SellSymTerm:derivate(..): derivation of u^v with v != const"),e.deriv=new u("binop",["*",s.deriv,new u("binop",["*",i,new u("binop",["^",s,new u("binop",["-",i,new u("const",1)])])])]);break;default:alert("unimplemented: SellSymTerm:derivate(..): binop: "+l)}break;case"fct1":switch(r=e.v[0],n=e.v[1],this.derivate(t,n),r){case"sin":e.deriv=new u("binop",["*",n.deriv,new u("fct1",["cos",n])]);break;case"cos":e.deriv=new u("uniop",["-",new u("binop",["*",n.deriv,new u("fct1",["sin",n])])]);break;case"exp":e.deriv=new u("binop",["*",n.deriv,new u("fct1",["exp",n])]);break;case"sqrt":e.deriv=new u("binop",["/",n.deriv,new u("binop",["*",new u("const",2),new u("fct1",["sqrt",n])])]);break;default:alert("unimplemented: SellSymTerm:derivate(..): fct1: "+r)}break;default:alert("unimplemented: SellSymTerm:derivate(..): "+e.type)}if(a){let t=new c;return t.symbolIDs=this.symbolIDs,t.stack=[this.stack[0].deriv],t.optimize(),t}return null}eval(t,e=null){let s,i,r,n,a,p;switch(s=0,null==e&&(e=this.stack[0]),e.type){case"var":if(!(e.v in t))return alert("SellSymTerm:eval(..): variable "+e.v+" has no value!"),0;s=parseFloat(t[e.v]);break;case"const":s=e.v;break;case"uniop":switch(i=this.eval(t,e.v[1]),n=e.v[0],n){case"-":s=-i;break;default:alert("unimplemented: SellSymTerm:eval(..): uniop: "+n)}break;case"binop":switch(i=this.eval(t,e.v[1]),r=this.eval(t,e.v[2]),n=e.v[0],n){case"+":s=i+r;break;case"-":s=i-r;break;case"*":s=i*r;break;case"/":s=i/r;break;case"^":s=l.pow(i,r);break;default:alert("unimplemented: SellSymTerm:eval(..): binop: "+n)}break;case"fct1":switch(a=e.v[0],p=this.eval(t,e.v[1]),a){case"sin":s=l.sin(p);break;case"cos":s=l.cos(p);break;case"exp":s=l.exp(p);break;case"sqrt":s=l.sqrt(p);break;default:alert("unimplemented: SellSymTerm:eval(..): fct1: "+a)}break;case"fct2":switch(a=e.v[0],a){case"diff_ode":case"diff2_ode":let i=null,l=e.v[1].v.id;l in t?i=t[l]:alert("SellSymTerm:eval(..): unknown term "+l);let r=e.v[2].v,n=i.derivate(r);"diff2_ode"===a&&(n=n.derivate(r)),s=n.eval(t);break;default:alert("unimplemented: SellSymTerm:eval(..): fct1: "+a)}break;case"ode_fun":let h=e.v.id,o=null;h in t?o=t[h]:alert("SellSymTerm:eval(..): unknown term "+h),s=o.eval(t);break;default:alert("unimplemented: SellSymTerm:eval(..): "+e.type)}return s}optimize(t=null){let e,s,i,l=null==t;if(l&&(t=this.stack[0]),"uniop"===t.type)e=t.v[0],s=this.optimize(t.v[1]),t.v[1]=s,"-"===e&&"const"==s.type&&0==s.v&&(t.type="const",t.v=0);else if("fct1"===t.type)s=this.optimize(t.v[1]),t.v[1]=s;else if("binop"===t.type)if(e=t.v[0],s=this.optimize(t.v[1]),t.v[1]=s,i=this.optimize(t.v[2]),t.v[2]=i,"const"===s.type&&"const"===i.type)switch(t.type="const",e){case"+":t.v=s.v+i.v;break;case"-":t.v=s.v-i.v;break;case"*":t.v=s.v*i.v;break;case"/":t.v=s.v/i.v;break;default:alert("unimplemented: SellSymTerm:optimize(..): binop: "+e)}else"*"===e&&("const"===s.type&&0==s.v||"const"===i.type&&0==i.v)?(t.type="const",t.v=0):"*"===e&&"const"===s.type&&1==s.v?(t.type=i.type,t.v=i.v):"*"===e&&"const"===s.type&&-1==s.v?t=new u("uniop",["-",i]):"*"===e&&"const"===i.type&&1==i.v?(t.type=s.type,t.v=s.v):"*"===e&&"const"===i.type&&-1==s.v?t=new u("uniop",["-",s]):"+"===e&&"const"===s.type&&0==s.v?(t.type=i.type,t.v=i.v):"+"===e&&"const"===i.type&&0==i.v||"-"===e&&"const"===i.type&&0==i.v||"^"===e&&"const"===i.type&&1==i.v?(t.type=s.type,t.v=s.v):"-"===e&&"uniop"===i.type&&"-"===i.v[0]?t=new u("binop",["+",s,i.v[1]]):"+"===e&&"uniop"===i.type&&"-"===i.v[0]&&(t=new u("binop",["-",s,i.v[1]]));return l&&(this.stack[0]=t),t}integrateNumerically(t,e,s){if(s<e)return-this.integrateNumerically(t,s,e);let i=(s-e)/1e6,l=0;for(let t=e;t<s;t+=i){l+=(this.eval({varId:t})+this.eval({varId:t+i}))/2*i}return l}compareWithStringTerm(t,e=[]){this.state="",0==t.length&&(t="0");let s=this.getVariables();e.length>0&&(s=e);for(let e=0;e<50;e++){let i={};for(let t=0;t<s.length;t++)i[s[t]]=l.random(-1,1);let r=this.eval(i);if(r>1e3){e--;continue}let n=0;try{n=l.evaluate(t,i)}catch(t){return this.state="syntaxerror",!1}if("number"!=typeof n)return this.state="syntaxerror",!1;if(l.abs(r-n)>=1e-6)return!1}return!0}}class m{constructor(t,e,s=[]){this.m=t,this.n=e,this.elements=s}toString(){let t="[";for(let e=0;e<this.m;e++){e>0&&(t+=", "),t+="[";for(let s=0;s<this.n;s++)s>0&&(t+=", "),t+=this.elements[e*this.n+s].toString();t+="]"}return t+="]",t}}class d{constructor(t){this.p=t}getFunctionList(){return["abs","binomial","integrate","conj","sqrt","xgcd","det","rank","inv","eye","eigenvalues_sym","triu","sin","cos","asin","acos","tan","atan","norm2","dot","cross","linsolve","is_zero","min","max"]}parseCode(){for(this.p.terminal("§CODE_START");!this.p.is("§CODE_END")&&!this.p.is("§END");)this.p.is("input")?this.parseCodeProp():this.p.is("?")?this.parseCodeHint():this.parseAssign(),this.p.terminal("§EOL");this.p.is("§END")||this.p.terminal("§CODE_END")}parseCodeProp(){this.p.is("input")?this.p.next():this.p.err("expected input");let t=!1;this.p.is("rows")?(this.p.next(),t=!0):this.p.is("cols")?(this.p.next(),t=!1):this.p.err("expected 'rows' or 'cols'"),this.p.terminal(":=");let e=!0;this.p.is("resizable")?(this.p.next(),e=!0):this.p.is("static")?(this.p.next(),e=!1):this.p.err("expected 'resizable' or 'static'"),t?this.p.resizableRows=e:this.p.resizableCols=e}parseCodeHint(){this.p.is("?")?this.p.next():this.p.err("expected ?");let t=this.p.q.lastParsedInputSymbol;null==t&&this.p.err("Hint/explanation is forbidden, since there is no preceding input field");let e=this.p.q.html.length;this.p.textParser.parseText(!0),t.hint_html=this.p.q.html.substr(e),this.p.q.html=this.p.q.html.substr(0,e)}chooseFromSet(t){let e;if(4==t.length&&t[2].type===i.T_DOTS){let s=t[0].value,i=t[3].value,l=parseFloat(t[1].value)-s;e=Math.floor(Math.random()*(i-s+l)/l)*l+s}else{e=t[Math.floor(Math.random()*t.length)].value}return e}parseAssign(){this.p.q.stack=[];let t=!1,e=[],s=[],r=!1,a=0,h=0;if(this.p.ident(),e.push(this.p.id),"i"!==this.p.id&&"e"!==this.p.id||this.p.err("id '"+this.p.id+"' is a reserved symbol"),this.p.is("(")){for(t=!0,this.p.next(),this.p.ident(),s.push(this.p.id);this.p.is(",");)this.p.next(),this.p.ident(),s.push(this.p.id);this.p.terminal(")")}else if(this.p.is("[")){this.p.next(),r=!0,this.parseExpr();let t=this.p.q.stack.pop();t.type==i.T_REAL&&p.isInteger(t.value)||this.p.err("row index is not an integer value"),a=t.value,this.p.terminal(","),this.parseExpr(),t=this.p.q.stack.pop(),t.type==i.T_REAL&&p.isInteger(t.value)||this.p.err("column index is not an integer value"),h=t.value,this.p.terminal("]")}else for(;this.p.is(",");)this.p.next(),this.p.ident(),e.push(this.p.id);if(this.p.is(":=")||this.p.is("=")){this.p.next(),t?this.p.codeSymParser.parseSymbolicTerm(s):this.parseExpr();let l=this.p.q.stack.pop();if(r){l.type!=i.T_REAL&&this.p.err("right-hand side must be of type real"),e[0]in this.p.q.symbols||this.p.err("unkown symbol '"+e[0]+"'");let t=this.p.q.symbols[e[0]];t.type!=i.T_MATRIX&&this.p.err("symbol '"+e[0]+"' is not a matrix"),t.value=o.mat_set_element(t.value,a-1,h-1,l.value),null==t.value&&this.p.err("invalid indices")}else for(let t=0;t<e.length;t++)this.p.q.symbols[e[t]]=l}else if(this.p.is("in"))if(t&&this.p.err("cannot apply 'in' to a function"),this.p.next(),this.p.is("MM")){this.parseMatrixDef();let t=this.p.q.stack.pop(),s=t.value[0],r=t.value[1],a=t.value[2],p=t.value[3],h=t.value[4];for(let t=0;t<e.length;t++){let o=l.zeros(s,r),u=0;do{for(let t=0;t<s;t++)for(let e=0;e<r;e++){let s=this.chooseFromSet(a.value);o.subset(l.index(t,e),s)}if(h)for(let t=1;t<s;t++)for(let e=0;e<t;e++){let s=o.subset(l.index(t,e));o=o.subset(l.index(e,t),s)}if(!p)break;u>256&&this.p.err("matrix generation failed: too many iterations"),u++}while(l.abs(l.det(o))<1e-16);this.p.q.symbols[e[t]]=new n(i.T_MATRIX,o)}}else if(this.p.is("{")||this.p.isIdent()){this.p.is("{")?this.parseSet():this.parseExpr();let t=this.p.q.stack.pop();t.type!=i.T_SET&&this.p.err("expected a set");let s=this.p.backupLexer(),l=0;for(;;){l>1e3&&this.p.err("constraints for random variables cannot be fulfilled"),l++;for(let s=0;s<e.length;s++){let l=this.chooseFromSet(t.value);this.p.q.symbols[e[s]]=new n(i.T_REAL,l)}if(this.p.replayLexer(s),!this.p.is("with"))break;{this.p.next(),this.parseExpr();let t=this.p.q.stack.pop();if(t.type!=i.T_BOOL&&this.p.err("constraint must be boolean"),t.value)break}}}else this.p.err("unexpected '"+this.p.tk+"'");else this.p.err("expected ':=' or '=' or 'in'")}parseExpr(){this.parseOr()}parseOr(){if(this.parseAnd(),this.p.is("or")){let t=this.p.tk;this.p.next(),this.parseAnd();let e=this.p.q.stack.pop(),s=this.p.q.stack.pop();s.type==i.T_BOOL&&e.type==i.T_BOOL?this.p.pushSym(i.T_BOOL,s.value||e.value):this.p.err("types not compatible for '"+t+"' (must be boolean)")}}parseAnd(){if(this.parseEqual(),this.p.is("and")){let t=this.p.tk;this.p.next(),this.parseEqual();let e=this.p.q.stack.pop(),s=this.p.q.stack.pop();s.type==i.T_BOOL&&e.type==i.T_BOOL?this.p.pushSym(i.T_BOOL,s.value&&e.value):this.p.err("types not compatible for '"+t+"' (must be boolean)")}}parseEqual(){if(this.parseCompare(),this.p.is("==")||this.p.is("!=")){let t=this.p.tk;this.p.next(),this.parseCompare();let e=this.p.q.stack.pop(),s=this.p.q.stack.pop();if(s.type==i.T_REAL&&e.type==i.T_REAL){let r=l.abs(s.value-e.value)<1e-14;switch(t){case"==":this.p.pushSym(i.T_BOOL,r);break;case"!=":this.p.pushSym(i.T_BOOL,!r)}}else if(s.type==i.T_MATRIX&&e.type==i.T_MATRIX){let l=o.mat_compare_numerically(s.value,e.value);switch(t){case"==":this.p.pushSym(i.T_BOOL,l);break;case"!=":this.p.pushSym(i.T_BOOL,!l)}}else this.p.err("types not compatible for '"+t+"'")}}parseCompare(){if(this.parseAdd(),this.p.is("<=")||this.p.is("<")||this.p.is(">=")||this.p.is(">")){let t=this.p.tk;this.p.next(),this.parseAdd();let e=this.p.q.stack.pop(),s=this.p.q.stack.pop();if(s.type==i.T_REAL&&e.type==i.T_REAL)switch(t){case"<=":this.p.pushSym(i.T_BOOL,s.value<=e.value);break;case"<":this.p.pushSym(i.T_BOOL,s.value<e.value);break;case">=":this.p.pushSym(i.T_BOOL,s.value>=e.value);break;case">":this.p.pushSym(i.T_BOOL,s.value>e.value)}else this.p.err("types not compatible for '"+t+"'")}}parseAdd(){for(this.parseMul();this.p.is("+")||this.p.is("-");){let t=this.p.tk;this.p.next(),this.parseMul();let e=this.p.q.stack.pop(),s=this.p.q.stack.pop();if(s.type==i.T_REAL&&e.type==i.T_REAL)switch(t){case"+":this.p.pushSym(i.T_REAL,s.value+e.value);break;case"-":this.p.pushSym(i.T_REAL,s.value-e.value)}else if(s.type!=i.T_REAL&&s.type!=i.T_COMPLEX||e.type!=i.T_REAL&&e.type!=i.T_COMPLEX)if(s.type==i.T_MATRIX&&e.type==i.T_MATRIX){let r=s.value.size()[0],n=s.value.size()[1],a=e.value.size()[0],p=e.value.size()[1];r==a&&n==p||this.p.err("cannot apply '"+t+"' on ("+r+"x"+n+") and ("+a+"x"+p+") matrices"),this.p.pushSym(i.T_MATRIX,"+"==t?l.add(s.value,e.value):l.subtract(s.value,e.value))}else this.p.err("types not compatible for '"+t+"'");else switch(t){case"+":this.p.pushSym(i.T_COMPLEX,l.add(s.value,e.value));break;case"-":this.p.pushSym(i.T_COMPLEX,l.subtract(s.value,e.value))}}}parseMul(){for(this.parsePow();this.p.is("*")||this.p.is("/")||this.p.is("mod");){let t=this.p.tk;this.p.next(),this.parsePow();let e=this.p.q.stack.pop(),s=this.p.q.stack.pop();if(s.type==i.T_REAL&&e.type==i.T_REAL)switch(t){case"*":this.p.pushSym(i.T_REAL,s.value*e.value);break;case"/":this.p.pushSym(i.T_REAL,s.value/e.value);break;case"mod":this.p.isNumberInt(s.value)&&this.p.isNumberInt(e.value)||this.p.err("operator 'mod' expectes integral operands"),this.p.pushSym(i.T_REAL,l.mod(l.round(s.value),l.round(e.value)))}else if(s.type!=i.T_REAL&&s.type!=i.T_COMPLEX||e.type!=i.T_REAL&&e.type!=i.T_COMPLEX)if(s.type==i.T_MATRIX&&e.type==i.T_MATRIX)switch(t){case"*":let r=s.value.size()[0],n=s.value.size()[1],a=e.value.size()[0],p=e.value.size()[1];n!=a&&this.p.err("cannot multiply ("+r+"x"+n+") and ("+a+"x"+p+") matrices"),this.p.pushSym(i.T_MATRIX,l.multiply(s.value,e.value));break;case"/":case"mod":this.p.err("types not compatible for '"+t+"'")}else if(s.type==i.T_MATRIX&&e.type==i.T_REAL)switch(t){case"*":this.p.pushSym(i.T_MATRIX,l.multiply(s.value,e.value));break;case"mod":this.p.isNumberInt(e.value)||this.p.err("operator 'mod' expectes integral operands"),this.p.pushSym(i.T_MATRIX,o.mat_mod(s.value,e.value));break;default:console.log(s.value.toString()),this.p.err("types not compatible for '"+t+"'")}else if(s.type==i.T_REAL&&e.type==i.T_MATRIX)switch(t){case"*":this.p.pushSym(i.T_MATRIX,l.multiply(s.value,e.value));break;default:this.p.err("types not compatible for '"+t+"'")}else this.p.err("types not compatible for '"+t+"'");else switch(t){case"*":this.p.pushSym(i.T_COMPLEX,l.multiply(s.value,e.value));break;case"/":this.p.pushSym(i.T_COMPLEX,l.divide(s.value,e.value));break;case"mod":this.p.err("types not compatible for '"+t+"'")}}}parsePow(){for(this.parseUnary();this.p.is("^");){let t=this.p.tk;this.p.next(),this.parseUnary();let e=this.p.q.stack.pop(),s=this.p.q.stack.pop();if(s.type==i.T_REAL&&e.type==i.T_REAL)switch(t){case"^":this.p.pushSym(i.T_REAL,l.pow(s.value,e.value))}else if(s.type!=i.T_REAL&&s.type!=i.T_COMPLEX||e.type!=i.T_REAL&&e.type!=i.T_COMPLEX)if(s.type==i.T_MATRIX&&e.type==i.T_MATRIX_TRANSPOSE)switch(t){case"^":this.p.pushSym(i.T_MATRIX,l.transpose(s.value))}else this.p.err("types not compatible for '"+t+"'");else switch(t){case"^":this.p.pushSym(i.T_COMPLEX,l.pow(s.value,e.value))}}}parseUnary(){if(this.p.is("-")){this.p.next(),this.parseUnary();let t=this.p.q.stack.pop();t.type==i.T_REAL?this.p.pushSym(i.T_REAL,-t.value):this.p.err("unary '-' must be followed by type real")}else if(this.p.isInt()){let t=parseInt(this.p.tk);this.p.next(),this.p.is(".")&&(this.p.next(),p.isInteger(this.p.tk)||this.p.err("expected decimal places after '.'"),t=parseFloat(t+"."+this.p.tk),this.p.next()),this.p.q.stack.push(new n(i.T_REAL,t))}else if(this.p.is("true"))this.p.next(),this.p.q.stack.push(new n(i.T_BOOL,!0));else if(this.p.is("false"))this.p.next(),this.p.q.stack.push(new n(i.T_BOOL,!1));else if(this.p.is("not")){this.p.next(),this.parseUnary();let t=this.p.q.stack.pop();t.type!=i.T_BOOL&&this.p.err("expected boolean datatype as argument for 'not'"),this.p.q.stack.push(new n(i.T_BOOL,!t.value))}else if(this.p.is("i")||this.p.is("j"))this.p.q.stack.push(new n(i.T_COMPLEX,l.complex(0,1))),this.p.next();else if(this.p.is("T"))this.p.q.stack.push(new n(i.T_MATRIX_TRANSPOSE,"T")),this.p.next();else if(this.getFunctionList().includes(this.p.tk))this.parseFunctionCall();else if(this.p.isIdent()){let t=this.p.tk;this.p.next(),t in this.p.q.symbols==0&&this.p.err("unknown identifier '"+t+"'");let e=this.p.q.symbols[t];if(e.type==i.T_FUNCTION&&this.p.is("(")){this.p.next(),this.parseAdd();let t=[this.p.q.stack.pop()];for(;this.p.is(",");)this.p.next(),this.parseAdd(),t.push(this.p.q.stack.pop());let s=e.value,l=s.symbolIDs;l.length!=t.length&&this.p.err("number of arguments does not correspond to function definition");let r={};for(let e=0;e<l.length;e++)t[e].type!=i.T_REAL&&this.p.err("all arguements must be scalar and real valued"),r[l[e]]=t[e].value;let a=s.eval(r),p=new n(i.T_REAL,a);this.p.q.stack.push(p),this.p.terminal(")")}else this.p.q.stack.push(e)}else this.p.is("...")?(this.p.next(),this.p.q.stack.push(new n(i.T_DOTS))):this.p.is("{")?this.parseSet():this.p.is("[")?this.parseMatrix():this.p.is("(")?(this.p.next(),this.parseExpr(),this.p.terminal(")")):this.p.err("expected unary, got '"+this.p.tk+"'");this.p.is("!")&&this.parseFactorial()}parseMatrix(){this.p.terminal("[");let t=-1,e=0,s=[],a=null;for(;this.p.is("[")||this.p.is(",");){e>0&&this.p.terminal(","),this.p.terminal("[");let l=0;for(;!this.p.is("]")&&!this.p.is("§EOF");){l>0&&this.p.terminal(","),this.parseExpr();let t=this.p.q.stack.pop();t.type!=i.T_REAL&&t.type!=i.T_FUNCTION&&this.p.err("matrix element must be of type real or function"),null==a?a=t.type:t.type!=a&&this.p.err("all matrix elements must have same type"),s.push(t.value),l++}-1==t?t=l:l!=t&&this.p.err("matrix has different number of cols per row"),this.p.terminal("]"),e++}(e<1||t<1)&&this.p.err("matrix must have at least one row and one column"),this.p.terminal("]");let p=null,h=a==i.T_REAL?i.T_MATRIX:i.T_MATRIX_OF_FUNCTIONS;if(h==i.T_MATRIX){p=l.zeros(e,t),r(s.length==e*t);for(let i=0;i<e;i++)for(let e=0;e<t;e++)p=o.mat_set_element(p,i,e,s[i*t+e])}else p=new m(e,t,s);this.p.q.stack.push(new n(h,p))}parseFunctionCall(){this.p.ident();let t=this.p.id;this.p.terminal("(");let e=[];for(;!this.p.is(")")&&!this.p.is("§EOL")&&!this.p.is("§EOF");)e.length>0&&this.p.terminal(","),"integrate"==t&&1==e.length?(this.p.ident(),e.push(this.p.id)):(this.parseExpr(),e.push(this.p.q.stack.pop()));if(this.p.terminal(")"),"abs"===t)(1!=e.length||e[0].type!=i.T_REAL&&e[0].type!=i.T_COMPLEX)&&this.p.err("signature must be 'abs(real|complex)'"),this.p.pushSym(i.T_REAL,l.abs(e[0].value));else if("sqrt"===t){(1!=e.length||e[0].type!=i.T_REAL&&e[0].type!=i.T_COMPLEX)&&this.p.err("signature must be 'sqrt(real|complex)'");let t=l.sqrt(e[0].value),s="Complex"==l.typeOf(t);this.p.pushSym(s?i.T_COMPLEX:i.T_REAL,t)}else if(["sin","asin","cos","acos","tan","atan"].includes(t)){1==e.length&&e[0].type==i.T_REAL||this.p.err("signature must be '"+t+"(real)'");let s=0;switch(t){case"sin":s=l.sin(e[0].value);break;case"asin":s=l.asin(e[0].value);break;case"cos":s=l.cos(e[0].value);break;case"acos":s=l.acos(e[0].value);break;case"tan":s=l.tan(e[0].value);break;case"atan":s=l.atan(e[0].value);break;default:this.p.err("UNIMPLEMENTED: "+t)}this.p.pushSym(i.T_REAL,s)}else if("conj"===t)1==e.length&&e[0].type==i.T_COMPLEX||this.p.err("signature must be 'conj(complex)'"),this.p.pushSym(i.T_COMPLEX,l.conj(e[0].value));else if("binomial"===t)2==e.length&&e[0].type==i.T_REAL&&e[1].type==i.T_REAL&&this.p.isNumberInt(e[0].value)&&this.p.isNumberInt(e[1].value)||this.p.err("signature must be 'binomial(int,int)'"),this.p.pushSym(i.T_REAL,l.combinations(l.round(e[0].value),l.round(e[1].value)));else if("xgcd"===t)3==e.length&&e[0].type==i.T_REAL&&e[1].type==i.T_REAL&&e[2].type==i.T_REAL&&this.p.isNumberInt(e[0].value)&&this.p.isNumberInt(e[1].value)&&this.p.isNumberInt(e[2].value)||this.p.err("signature must be 'xgcd(int,int,int)'"),this.p.pushSym(i.T_REAL,l.subset(l.xgcd(e[0].value,e[1].value),l.index(e[2].value-1)));else if("integrate"===t){4==e.length&&e[0].type==i.T_FUNCTION&&"string"==typeof e[1]&&e[2].type==i.T_REAL&&e[3].type==i.T_REAL||this.p.err("signature must be 'integrate(function, string, real, real)'");let t=e[0].value.integrateNumerically(e[1],e[2].value,e[3].value),s=.001;this.p.pushSym(i.T_REAL,t,s)}else if(["det","rank","inv","eigenvalues_sym","triu","norm2"].includes(t))if(1==e.length&&e[0].type==i.T_MATRIX||this.p.err("signature must be '"+t+"(matrix)'"),"det"===t)this.p.pushSym(i.T_REAL,l.det(e[0].value));else if("rank"===t)this.p.pushSym(i.T_REAL,o.mat_rank(e[0].value));else if("inv"===t)this.p.pushSym(i.T_MATRIX,l.inv(e[0].value));else if("eigenvalues_sym"===t){o.mat_is_symmetric(e[0].value)||this.p.err("matrix is not symmetric");let t=l.eigs(e[0].value).values._data,s=[];for(let e=0;e<t.length;e++)s.push(new n(i.T_REAL,t[e]));this.p.pushSym(i.T_SET,s)}else"triu"===t?this.p.pushSym(i.T_MATRIX,o.mat_triu(e[0].value)):"norm2"===t?this.p.pushSym(i.T_REAL,o.mat_norm2(e[0].value)):r(!1);else if("eye"===t)1==e.length&&e[0].type==i.T_REAL&&this.p.isNumberInt(e[0].value)||this.p.err("signature must be 'eye(integer)'"),this.p.pushSym(i.T_MATRIX,l.identity(l.round(e[0].value)));else if("dot"===t)2==e.length&&e[0].type==i.T_MATRIX&&e[1].type==i.T_MATRIX||this.p.err("signature must be 'dot(columnVector,columnVector)'"),1!=o.mat_get_col_count(e[0].value)&&this.p.err("signature must be 'dot(columnVector,columnVector)'"),1!=o.mat_get_col_count(e[1].value)&&this.p.err("signature must be 'dot(columnVector,columnVector)'"),o.mat_get_row_count(e[0].value)!=o.mat_get_row_count(e[1].value)&&this.p.err("vectors in 'dot(..)' must have equal length"),this.p.pushSym(i.T_REAL,o.mat_vecdot(e[0].value,e[1].value));else if("cross"===t)2==e.length&&e[0].type==i.T_MATRIX&&e[1].type==i.T_MATRIX||this.p.err("signature must be 'cross(columnVector,columnVector)'"),1!=o.mat_get_col_count(e[0].value)&&this.p.err("signature must be 'cross(columnVector,columnVector)'"),1!=o.mat_get_col_count(e[1].value)&&this.p.err("signature must be 'cross(columnVector,columnVector)'"),3!=o.mat_get_row_count(e[0].value)&&this.p.err("vectors in 'cross(..)' must have length 3"),3!=o.mat_get_row_count(e[1].value)&&this.p.err("vectors in 'cross(..)' must have length 3"),this.p.pushSym(i.T_MATRIX,o.mat_veccross(e[0].value,e[1].value));else if("linsolve"===t)2==e.length&&e[0].type==i.T_MATRIX&&e[1].type==i.T_MATRIX||this.p.err("signature must be 'linsolve(matrix,columnVector)'"),o.mat_get_col_count(e[0].value)!=o.mat_get_row_count(e[0].value)&&this.p.err("matrix must be square, i.e. m=n"),1!=o.mat_get_col_count(e[1].value)&&this.p.err("second parameter must be a colum vector"),o.mat_get_row_count(e[0].value)!=o.mat_get_row_count(e[1].value)&&this.p.err("number of rows of matrix and does not match vector"),this.p.pushSym(i.T_MATRIX,o.linsolve(e[0].value,e[1].value));else if("is_zero"===t)1==e.length&&e[0].type==i.T_MATRIX||this.p.err("signature must be 'is_zero(matrix)'"),this.p.pushSym(i.T_BOOL,o.mat_is_zero(e[0].value));else if("min"===t){1==e.length&&e[0].type==i.T_SET||this.p.err("signature must be 'min(set)'");let t=1e13;for(let s=0;s<e[0].value.length;s++)e[0].value[s].value<t&&(t=e[0].value[s].value);this.p.pushSym(i.T_REAL,t)}else if("max"===t){1==e.length&&e[0].type==i.T_SET||this.p.err("signature must be 'max(set)'");let t=-1e13;for(let s=0;s<e[0].value.length;s++)e[0].value[s].value>t&&(t=e[0].value[s].value);this.p.pushSym(i.T_REAL,t)}else this.p.err("unimplemented function call '"+t+"'")}parseFactorial(){this.p.terminal("!");let t=this.p.q.stack.pop();t.type==i.T_REAL?this.p.pushSym(i.T_REAL,l.factorial(t.value)):this.p.err("types not compatible for '!'")}parseMatrixDef(){this.p.terminal("MM"),this.p.terminal("("),this.parseExpr();let t=this.p.q.stack.pop();t.type===i.T_REAL&&this.p.isNumberInt(t.value)||this.p.err("expected integer for the number of rows");let e=l.round(t.value);e<=0&&this.p.err("number of matrix cols must be > 0 (actually is '"+e+"')"),this.p.terminal("x"),this.parseExpr();let s=this.p.q.stack.pop();s.type===i.T_REAL&&this.p.isNumberInt(s.value)||this.p.err("expected integer for the number of columns");let r=l.round(s.value);r<=0&&this.p.err("number of matrix rows must be > 0 (actually is '"+r+"')"),this.p.terminal("|"),this.parseExpr();let n=this.p.q.stack.pop();n.type!==i.T_SET&&this.p.err("expected set from which matrix elements are drawn");let a=!1,p=!1;for(;this.p.is(",");){this.p.next();let t=this.p.tk;switch(t){case"invertible":a=!0;break;case"symmetric":p=!0;break;default:this.p.err("unknown property '"+t+"'")}this.p.next()}this.p.terminal(")"),this.p.pushSym(i.T_MATRIX_DEF,[e,r,n,a,p])}parseSet(){this.p.terminal("{");let t=0,e=new n(i.T_SET);e.value=[];let s=!1;for(;!this.p.is("}")&&!this.p.is("§EOF");){t>0&&this.p.terminal(","),this.parseExpr();let l=this.p.q.stack.pop();e.value.push(l),l.type!==i.T_REAL&&(2==t&&l.type===i.T_DOTS?s=!0:l.type===i.T_COMPLEX?e.type=i.T_COMPLEX_SET:this.p.err("set must consist of real values only")),t++}if((s&&4!=t||s&&e.type==i.T_COMPLEX_SET)&&this.p.err("if set contains '...', then it must have 4 real-valued elements"),e.type==i.T_COMPLEX_SET)for(let t=0;t<e.value.length;t++)e.value[t].type==i.T_REAL&&(e.value[t].value=l.complex(e.value[t].value,0));this.p.q.stack.push(e),this.p.terminal("}")}}class b{constructor(t){this.p=t}parseSymbolicTerm(t){let e=new c(t);this.parseSymbolicTerm_Add(e),e.optimize(),this.p.q.stack.push(new n(i.T_FUNCTION,e))}parseSymbolicTerm_Expr(t){this.parseSymbolicTerm_Add(t)}parseSymbolicTerm_Add(t){for(this.parseSymbolicTerm_Mul(t);this.p.is("+")||this.p.is("-");){let e=this.p.tk;this.p.next(),this.parseSymbolicTerm_Mul(t),t.pushBinaryOperation(e)}}parseSymbolicTerm_Mul(t){for(this.parseSymbolicTerm_Pow(t);this.p.is("*")||this.p.is("/");){let e=this.p.tk;this.p.next(),this.parseSymbolicTerm_Pow(t),t.pushBinaryOperation(e)}}parseSymbolicTerm_Pow(t){for(this.parseSymbolicTerm_Unary(t);this.p.is("^");){let e=this.p.tk;this.p.next(),this.parseSymbolicTerm_Unary(t),t.pushBinaryOperation(e)}}parseSymbolicTerm_Unary(t){if(this.p.is("("))this.p.terminal("("),this.parseSymbolicTerm_Expr(t),this.p.terminal(")");else if(this.p.isNumber()){let e=parseFloat(this.p.tk);this.p.next(),this.p.is("!")&&(this.p.isNumberInt(e)||this.p.err("expected integer for '!'"),this.p.next(),e=l.factorial(e)),t.pushConstant(e)}else if(["exp","sin","cos","sqrt"].includes(this.p.tk)){let e=this.p.tk;this.p.next(),this.p.terminal("("),this.parseSymbolicTerm_Expr(t),this.p.terminal(")"),t.pushUnaryFunction(e)}else if(this.p.is("diff")){this.p.next(),this.p.terminal("("),this.parseSymbolicTerm_Expr(t),this.p.terminal(","),this.p.ident();let e=this.p.id;this.p.terminal(")"),t.pushVariable(e),t.pushDiff()}else if(this.p.isIdent()){let e=this.p.tk;if(this.p.next(),e in this.p.q.symbols){let s=this.p.q.symbols[e];if(s.type===i.T_REAL)t.pushConstant(s.value);else if(s.type==i.T_FUNCTION)if(this.p.is("(")){let l=[];for(this.p.terminal("(");!this.p.is(")")&&!this.p.is("§EOF");){l.length>0&&this.p.terminal(","),this.p.codeParser.parseExpr();let t=this.p.q.stack.pop();t.type!==i.T_REAL&&this.p.err("paremeter must be of type 'real'"),l.push(t.value)}this.p.terminal(")"),s.value.symbolIDs.length!=l.length&&this.p.err("number of parameters does not match definition of function '"+e+"'");let r={};for(let t=0;t<s.value.symbolIDs.length;t++)r[s.value.symbolIDs[t]]=l[t];t.pushConstant(s.value.eval(r))}else t.pushSymbolicTerm(s.value);else this.p.err("identifer '"+e+"' must be of type 'real'")}else t.pushVariable(e)}else this.p.is("-")?(this.p.next(),this.parseSymbolicTerm_Pow(t),t.pushUnaryOperation("-")):this.p.err("expected unary")}}class _{constructor(t){this.p=t}parseInlineMath(){let t="";for(this.p.terminal("$"),t+=" `";!this.p.is("$")&&!this.p.is("§END");)t+=this.parseIM_Expr();t+="` ",this.p.terminal("$"),this.p.q.html+=' <span style="font-size: 13pt;">'+t.replaceAll("``","")+"</span> "}parseIM_Expr(){return this.parseIM_List()}parseIM_List(){let t=this.parseIM_Assign();for(;this.p.is(",")||this.p.is(":")||this.p.is("->")||this.p.is("|->");){let e=this.p.tk;this.p.next(),t+=" "+e+" "+this.parseIM_Assign()}return t}parseIM_Assign(){let t=this.parseIM_OtherBinaryOp();for(;this.p.is("=");)this.p.next(),t=t+" = "+this.parseIM_OtherBinaryOp();return t}parseIM_OtherBinaryOp(){let t=this.parseIM_Relational();for(;this.p.is("in")||this.p.is("notin")||this.p.is("uu")||this.p.is("^^")||this.p.is("vv")||this.p.is("@");){let e=this.p.tk;this.p.next(),t=t+" "+e+" "+this.parseIM_Relational()}return t}parseIM_Relational(){let t=this.parseIM_Add();for(;this.p.is("<")||this.p.is("<=")||this.p.is(">")||this.p.is(">=")||this.p.is("!=");){let e=this.p.tk;this.p.next(),t=t+" "+e+" "+this.parseIM_Add()}return t}parseIM_Add(){let t=this.parseIM_Mul();for(;this.p.is("+")||this.p.is("-");){let e=this.p.tk;this.p.next(),t=t+" "+e+" "+this.parseIM_Mul()}return t}parseIM_Mul(){let t=this.parseIM_Pow();for(;this.p.is("*")||this.p.is("/");){let e=this.p.tk;this.p.next(),t=t+" "+e+" "+this.parseIM_Pow()}return t}parseIM_Pow(){let t=this.parseIM_Unary();for(;this.p.is("^");){let e=this.p.tk;this.p.next(),t=t+" "+e+" "+this.parseIM_Unary()}return t}parseIM_Unary(){let t="";if(this.p.is("#"))t+="`"+this.p.imInputParser.parseIM_Input()+"`";else if(this.p.is("text")){for(this.p.next(),this.p.terminal("("),t+=" ` ";!this.p.is(")")&&!this.p.is("§EOF");)t+=this.p.tk,this.p.next();t+=" ` ",this.p.terminal(")")}else if(this.p.is("augmented")){this.p.next(),this.p.terminal("(");let e=null,s=null;this.p.isIdent()?(this.p.tk in this.p.q.symbols&&this.p.q.symbols[this.p.tk].type==i.T_MATRIX?e=this.p.q.symbols[this.p.tk].value:this.p.err("expected a matrix"),this.p.next()):this.p.err("expected a matrix"),this.p.terminal("|"),this.p.isIdent()?(this.p.tk in this.p.q.symbols&&this.p.q.symbols[this.p.tk].type==i.T_MATRIX?s=this.p.q.symbols[this.p.tk].value:this.p.err("expected a column vector"),this.p.next()):this.p.err("expected a column vector"),this.p.terminal(")");let l=o.mat_get_row_count(e),r=o.mat_get_col_count(e);1!=o.mat_get_col_count(s)&&this.p.err("expected a column vector"),o.mat_get_row_count(s)!=r&&this.p.err("matrix rows and vector rows not matching");let n="(";for(let t=0;t<l;t++){n+="(";for(let s=0;s<r;s++)n+=o.mat_get_element_value(e,t,s)+",";n+="|,"+o.mat_get_element_value(s,t,0),n+=")",t<l-1&&(n+=",")}n+=")",t+=n+" "}else if(this.p.is("sum")||this.p.is("prod")||this.p.is("lim")||this.p.is("int"))t+=" "+this.p.tk,this.p.next(),this.p.is("_")&&(this.p.next(),t+="_"+this.parseIM_Expr()),this.p.is("^")&&(this.p.next(),t+="^"+this.parseIM_Expr()),t+=" ";else if(this.p.is("RR")||this.p.is("ZZ")||this.p.is("QQ")||this.p.is("CC"))t+=this.p.tk+" ",this.p.next();else if(this.p.is("oo")||this.p.is("infty"))t+=this.p.tk+" ",this.p.next();else if(this.p.is("equiv")||this.p.is("mod"))t+=this.p.tk+" ",this.p.next();else if(this.p.is("EE")||this.p.is("AA"))t+=this.p.tk+" ",this.p.next(),t+=this.parseIM_Expr();else if(this.p.is("dx")||this.p.is("dy")||this.p.is("dz"))t+="\\ \\ "+this.p.tk,this.p.next();else if(this.p.is("bar"))t+=this.p.tk+" ",this.p.next(),t+=this.parseIM_Unary();else if(this.p.is("-"))this.p.next(),t+="-",t+=this.parseIM_Unary();else if(this.p.is(" "))t+=" ",this.p.next();else if(this.p.isNumber())t+=this.p.tk,this.p.next();else if(this.p.isIdent()){let e=this.p.tk;for(this.p.next();"_"==this.p.tk;)e+="_",this.p.next(),(this.p.isIdent()||this.p.isNumber())&&(e+=this.p.tk,this.p.next());if(e in this.p.q.symbols)if(this.p.q.symbols[e].type==i.T_MATRIX&&this.p.is("[")){let s=0,l=0,r=!1,n=!1;this.p.next(),this.p.is(":")?(this.p.next(),r=!0):this.p.isInt()?(s=parseInt(this.p.tk),this.p.next()):this.p.err("expected integer for matrix row"),this.p.terminal(","),this.p.is(":")?(this.p.next(),n=!0):this.p.isInt()?(l=parseInt(this.p.tk),this.p.next()):this.p.err("expected integer for matrix col"),this.p.terminal("]");let a=this.p.q.symbols[e];a.type!=i.T_MATRIX&&this.p.err("'"+e+"' is not a matrix");let p=r?0:s-1,h=r?-1:s-1,u=n?0:l-1,c=n?-1:l-1,m=o.mat_submatrix(a.value,p,h,u,c);null==m&&this.p.err("invalid indices"),t+=m.toString()}else t+=this.p.q.symbols[e].toAsciiMath();else t+=e}else if(this.p.is('"')){this.p.next(),this.p.ident();let e=this.p.id;for(;"_"==this.p.tk;)e+="_",this.p.next(),(this.p.isIdent()||this.p.isNumber())&&(e+=this.p.tk,this.p.next());t+=e,this.p.terminal('"')}else if(this.p.is("(")){for(this.p.next(),t+="(";!this.p.is(")")&&!this.p.is("§EOF");)t+=this.parseIM_Expr();this.p.terminal(")"),t+=")"}else if(this.p.is("{")){for(this.p.next(),t+="{ ";!this.p.is("}")&&!this.p.is("§EOF");)t+=this.parseIM_Expr();this.p.terminal("}"),t+=" }"}else if(this.p.is("|"))this.p.next(),t+="|";else if(this.p.is("\\"))this.p.next(),t+="\\ \\ ";else if(this.p.is("\\\\")||this.p.is("setminus"))this.p.next(),t+="setminus";else if(this.p.is("..."))this.p.next(),t+="... ";else if(this.p.is("[")&&this.p.is2("[")||this.p.is("(")&&this.p.is2("("))t+=this.parseIM_Matrix();else if(this.p.is("[")||this.p.is("]")){for(t+=this.p.tk,this.p.next();!this.p.is("]")&&!this.p.is("[")&&!this.p.is("§EOF");)t+=this.parseIM_Expr();this.p.is("[")||this.p.is("]")?(t+=this.p.tk,this.p.next()):this.p.err("expected '[' or ']'")}else this.p.err("expected unary, got '"+this.p.tk+"'");for(this.p.is("!")&&(this.p.next(),t+="! ");this.p.is("'");)this.p.next(),t+="'";return t}parseIM_Matrix(){let t="",e="",s="";this.p.is("[")&&this.p.is2("[")?(e="[",s="]",this.p.next(),t+=e):this.p.is("(")&&this.p.is2("(")?(e="(",s=")",this.p.next()):this.p.err("expected [ or (");let i=-1,l=0;for(;this.p.is(e)||this.p.is(",");){l>0&&(this.p.terminal(","),t+=","),this.p.terminal(e),t+=e;let r=0;for(;!this.p.is(s);)r>0&&(this.p.terminal(","),t+=","),t+=this.parseIM_Expr(),r++;-1==i?i=r:r!=i&&this.p.err("matrix has different number of cols per row"),this.p.terminal(s),t+=s,l++}return(l<1||i<1)&&this.p.err("matrix must have at least one row and one column"),this.p.terminal(s),t+=s,t}}function v(t,e){for(let s=0;s<t.children.length;s++){if(t.children[s].id==e)return t.children[s];if(t.children[s].hasChildNodes()){let i=v(t.children[s],e);if(null!=i)return i}}return null}function f(t="",e=""){const s=Array(e.length+1).fill(null).map((()=>Array(t.length+1).fill(null)));for(let e=0;e<=t.length;e+=1)s[0][e]=e;for(let t=0;t<=e.length;t+=1)s[t][0]=t;for(let i=1;i<=e.length;i+=1)for(let l=1;l<=t.length;l+=1){const r=t[l-1]===e[i-1]?0:1;s[i][l]=Math.min(s[i][l-1]+1,s[i-1][l]+1,s[i-1][l-1]+r)}return s[e.length][t.length]}class y{constructor(t,e,s,i,l=!1,r=!1,n=!1){this.question=null,this.input=null,this.m=2,this.n=2,this.wideInput=!1,this.resizableRows=!1,this.resizableCols=!1,this.ELEMENT_TYPE_INPUT="input",this.ELEMENT_TYPE_SPAN="span",this.question=t,this.input=e,this.m=s,this.n=i,this.wideInput=l,this.resizableRows=r,this.resizableCols=n}resize(t,e){let s=this.m,i=this.n,l=this.getStudentAnswer();this.m+=t,this.n+=e,this.m=this.m<1?1:this.m,this.n=this.n<1?1:this.n,this.updateHTML();for(let t=0;t<this.m;t++)for(let e=0;e<this.n;e++)t<s&&e<i&&this.setElementText(t,e,l[t*i+e])}getElementText(t,e){let s=this.input.htmlElementId+"_"+t+"_"+e;return v(this.question.bodyHtmlElement,s).value}setElementText(t,e,s){let i=this.input.htmlElementId+"_"+t+"_"+e;v(this.question.bodyHtmlElement,i).value=s}getStudentAnswer(){let t=[];for(let e=0;e<this.m;e++)for(let s=0;s<this.n;s++){let i=this.getElementText(e,s);t.push(i)}return t}setUnsetElementsToZero(){for(let t=0;t<this.m;t++)for(let e=0;e<this.n;e++){0==this.getElementText(t,e).length&&this.setElementText(t,e,"0")}}updateHTML(){let t=this.wideInput?20:4,e="";e+="<span>\n",e+='<table class="p-0 m-0" style="display:inline-block;border-spacing:0;border-collapse:collapse;">\n',e+="    <tr>\n",e+="        <td>\n",e+='            <table style="border-spacing:0;border-collapse:collapse;border-left:2px solid black;border-right:2px solid black;">\n';for(let s=0;s<this.m;s++){e+="                <tr>\n",0==s?e+='                    <td style="border-top:2px solid black;"></td>\n':s==this.m-1?e+='                    <td style="border-bottom:2px solid black;"></td>\n':e+="                    <td></td>\n";for(let i=0;i<this.n;i++){e+="                    <td>\n",e+='            <input type="text" id="'+(this.input.htmlElementId+"_"+s+"_"+i)+'" size="'+t+'" placeholder=""/>\n',e+="                    </td>\n"}0==s?e+='                    <td style="border-top:2px solid black;"></td>\n':s==this.m-1?e+='                    <td style="border-bottom:2px solid black;"></td>\n':e+="<td></td>\n",e+="                </tr>\n"}e+="            </table>\n",e+="        </td>\n",this.resizableCols&&(e+='        <td style="text-align:left">\n',e+='            <button class="matrix_size_button" style="font-size:18px;padding:0;border:none;background:none;" onclick="sellquiz.refreshMatrixDimensions('+this.question.idx+", '"+this.input.htmlElementId+"', 0, 1);\">&nbsp;&#8853;</button>\n",e+="            <br/>\n",e+='            <button class="matrix_size_button" style="font-size:18px;padding:0;border:none;background:none;" onclick="sellquiz.refreshMatrixDimensions('+this.question.idx+", '"+this.input.htmlElementId+"', 0, -1);\">&nbsp;&#8854;</button>\n",e+="        </td>\n"),e+="    </tr>\n",e+="    <tr>\n",this.resizableRows&&(e+='    <td style="text-align:center">\n',e+='        <button class="matrix_size_button" style="font-size:18px;padding:0;border:none;background:none;" onclick="sellquiz.refreshMatrixDimensions('+this.question.idx+", '"+this.input.htmlElementId+"', 1, 0);\">&#8853;</button>\n",e+="        &nbsp;\n",e+='        <button class="matrix_size_button" style="font-size:18px;padding:0;border:none;background:none;" onclick="sellquiz.refreshMatrixDimensions('+this.question.idx+", '"+this.input.htmlElementId+"', -1, 0);\">&#8854;</button>\n",e+="    </td>\n"),e+="        <td></td>\n",e+="    </tr>\n",e+="</table>\n",e+="</span>\n";let s=v(this.question.bodyHtmlElement,this.input.htmlElementId);r(null!=s,"MatrixInput.updateHTML(): question body HTML element is not set."),s.innerHTML=e}}class g{constructor(t){this.p=t}parseIM_Input(){let t="",e="";if(this.p.parseWhitespaces=!1,this.p.parsingInlineCode=!0,this.p.terminal("#"),this.p.is("[")){if(this.p.next(),this.p.is("diff")){for(this.p.next();this.p.is(" ");)this.p.next();this.p.isIdent()?(t=this.p.tk,this.p.next()):this.p.err("expected diff var")}else this.p.err("unknown property '"+this.p.tk+"'");this.p.terminal("]")}let s=null,l="";if(this.p.is('"')){this.p.next();let t=[],e="";for(;!this.p.is('"')&&!this.p.is("§EOF");)e+=this.p.tk,this.p.next();for(this.p.terminal('"'),t.push(e);this.p.is("|");){for(this.p.next(),e="",this.p.terminal('"');!this.p.is('"')&&!this.p.is("§EOF");)e+=this.p.tk,this.p.next();this.p.terminal('"'),t.push(e)}l="gap_"+this.p.createUniqueID(),s=new n(i.T_STRING_LIST,t),this.p.q.solutionSymbols[l]=s}else this.p.codeParser.parseUnary(),l="sol"+this.p.createUniqueID(),s=this.p.q.stack.pop(),this.p.q.lastParsedInputSymbol=s,this.p.q.solutionSymbols[l]=s;this.p.q.solutionSymbols[l]=s,t.length>0&&(this.p.q.solutionSymbolsMustDiffFirst[l]=t);let r=5,a=!1,p=0,h=0,u=new S;switch(u.htmlElementId="sellquiz_input_"+l,u.solutionVariableId=l,u.htmlElementId_feedback="sellquiz_feedback_"+l,this.p.q.inputs.push(u),s.type){case i.T_STRING:case i.T_STRING_LIST:r+=10,u.htmlElementInputType=A.TEXTFIELD,0==this.p.generateInputFieldHtmlCode?e+="$$"+u.htmlElementId:(e+=' <input type="text" value="" id="'+u.htmlElementId+'" size="'+r+'" placeholder=""> ',e+='<span id="'+u.htmlElementId_feedback+'"></span>');break;case i.T_REAL:case i.T_FUNCTION:s.type==i.T_FUNCTION&&(r+=10),u.htmlElementInputType=A.TEXTFIELD,0==this.p.generateInputFieldHtmlCode?(e+=" $$"+u.htmlElementId+" ",e+="$$"+u.htmlElementId_feedback+" "):(e+=' <input type="text" value="" id="'+u.htmlElementId+'" size="'+r+'" placeholder=""> ',e+='<span id="'+u.htmlElementId_feedback+'"></span>');break;case i.T_COMPLEX:u.htmlElementInputType=A.COMPLEX_NUMBER,0==this.p.generateInputFieldHtmlCode?(e+=" $$"+u.htmlElementId+" ",e+="$$"+u.htmlElementId_feedback+" "):(e+='<input type="text" name="sell_input" value="" id="'+u.htmlElementId+'_real" size="'+r+'" placeholder=""> `+` ',e+='<input type="text" name="sell_input" value="" id="'+u.htmlElementId+'_imag" size="'+r+'" placeholder=""> `i` ',e+='<span id="'+u.htmlElementId_feedback+'"></span>');break;case i.T_SET:case i.T_COMPLEX_SET:if(s.type==i.T_COMPLEX_SET&&(r+=5),u.htmlElementInputType=A.VECTOR,u.vectorLength=s.value.length,0==this.p.generateInputFieldHtmlCode)e+=" $$"+u.htmlElementId+" ",e+="$$"+u.htmlElementId_feedback+" ";else{e+="`{`";for(let t=0;t<s.value.length;t++)t>0&&(e+=" , "),e+=' <input type="text" name="sell_input" value="" id="'+u.htmlElementId+"_"+t+'" size="'+r+'" placeholder=""> ';e+="`}`",e+='<span id="'+u.htmlElementId_feedback+'"></span>'}break;case i.T_MATRIX:case i.T_MATRIX_OF_FUNCTIONS:a=s.type==i.T_MATRIX_OF_FUNCTIONS,s.type==i.T_MATRIX?(p=this.p.resizableRows?2:o.mat_get_row_count(s.value),h=this.p.resizableCols?2:o.mat_get_col_count(s.value)):(p=this.p.resizableRows?2:s.value.m,h=this.p.resizableCols?2:s.value.n),u.htmlElementInputType=A.MATRIX,u.matrixInput=new y(this.p.q,u,p,h,a,this.p.resizableRows,this.p.resizableCols),0==this.p.generateInputFieldHtmlCode?(e+=" $$"+u.htmlElementId+" ",e+="$$"+u.htmlElementId_feedback+" "):(e+='<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id="'+u.htmlElementId+'"></span>',e+='<span id="'+u.htmlElementId_feedback+'"></span>');break;default:this.p.err("unimplemented solution type '"+s.type+"'")}return this.p.debug&&(e+='<span class="text-warning">'+s.toAsciiMath()+"</span>"),this.p.parsingInlineCode=!1,this.p.parseWhitespaces=!0,e}}var I={feedback_syntaxerror_en:"Syntax error in '$'.",feedback_syntaxerror_de:"Syntaxfehler in '$'.",feedback_syntaxerror_or_invalid_variables_en:"Syntax error or invalid variables in '$'.",feedback_syntaxerror_or_invalid_variables_de:"Syntaxfehler oder unzulässive Variablen in '$'.",no_answer_selected_en:"No answer chosen.",no_answer_selected_de:"Keine Antwort gewählt.",not_yet_correct_en:"Not yet correct. Try again!",not_yet_correct_de:"Noch nicht korrekt. Nochmal versuchen!",dimensions_incorrect_en:"Dimensioned incorrectly!",dimensions_incorrect_de:"Falsche Dimensionierung!",hint_matrix_element_en:"Hint: Element ($i,$j) is incorrect!",hint_matrix_element_de:"Tipp: Element ($i,$j) ist noch fehlerhaft!",i_out_of_n_correct_en:"$i out of $n answers are correct",i_out_of_n_correct_de:"$i von $n Antworten sind korrekt"};const k=" &#x2705; ",T=" &#x274C; ";function x(t,e="en"){let s=t+"_"+e;return r(s in I,"GET_STR(..): unknown key "+s),'<span class="text-danger">'+I[s]+"</span>"}class E{constructor(t){this.selectedAnySingleChoiceOption=!1,this.questionContainsSingleChoice=!1,this.allMultipleChoiceAnswersAreCorrect=!0,this.p=t}setStudentAnswerManually(t,e,s){let i=this.p.getQuestionByIdx(t);if(null==i)return!1;let l=null;for(let t=0;t<i.inputs.length;t++)if(i.inputs[t].solutionVariableId==e){l=i.inputs[t];break}switch(null==l&&r(!1,"setStudentAnswerManually(): could not find input element for given solution variable '"+e+"'"),l.htmlElementInputType){case A.TEXTFIELD:l.studentAnswer=[s];break;default:r(!1,"setStudentAnswerManually(): UNIMPLEMENTED!")}return!0}getStudentAnswers(t){let e=this.p.getQuestionByIdx(t);if(null==e)return!1;null==e.bodyHtmlElement&&r(!1,"getStudentAnswers(): bodyHtmlElement was not set");for(let t=0;t<e.inputs.length;t++){let s=e.inputs[t],i=null;switch(s.htmlElementInputType){case A.TEXTFIELD:i=v(e.bodyHtmlElement,s.htmlElementId),r(null!=i,"getStudentAnswers(): failed to get HTML child element: "+s.htmlElementId),s.studentAnswer=[i.value];break;case A.COMPLEX_NUMBER:i=v(e.bodyHtmlElement,s.htmlElementId+"_real"),r(null!=i,"getStudentAnswers(): failed to get HTML child element: "+s.htmlElementId),0==i.value.length&&(i.value="0"),s.studentAnswer=[i.value],i=v(e.bodyHtmlElement,s.htmlElementId+"_imag"),r(null!=i,"getStudentAnswers(): failed to get HTML child element: "+s.htmlElementId),0==i.value.length&&(i.value="0"),s.studentAnswer.push(i.value);break;case A.CHECKBOX:i=v(e.bodyHtmlElement,s.htmlElementId),r(null!=i,"getStudentAnswers(): failed to get HTML child element: "+s.htmlElementId),s.studentAnswer=[i.checked?"true":"false"];break;case A.VECTOR:s.studentAnswer=[];for(let t=0;t<s.vectorLength;t++)i=v(e.bodyHtmlElement,s.htmlElementId+"_"+t),r(null!=i,"getStudentAnswers(): failed to get HTML child element: "+s.htmlElementId),0==i.value.length&&(i.value="0"),s.studentAnswer.push(i.value);break;case A.MATRIX:s.matrixInput.setUnsetElementsToZero(),s.studentAnswer=s.matrixInput.getStudentAnswer();break;default:r(!1,"getStudentAnswers(..): UNIMPLEMENTED HTML element type")}}return!0}displayFeedback(t){let e=this.p.getQuestionByIdx(t);if(null==e)return!1;null==e.bodyHtmlElement&&r(!1,"displayFeedback(): bodyHtmlElement was not set");for(let t=0;t<e.inputs.length;t++){let s=e.inputs[t],i=v(e.bodyHtmlElement,s.htmlElementId_feedback);r(null!=i,"displayFeedback(): failed to get HTML child element: "+s.htmlElementId),i.innerHTML=s.evaluationFeedbackStr}return!0}getScore(t){let e=this.p.questions[t];if(null==e)return-1;let s=0;if(0==e.inputs.length)return s;for(let t=0;t<e.inputs.length;t++){e.inputs[t].correct&&(s+=1)}return s/=e.inputs.length,s}evaluate(t){this.selectedAnySingleChoiceOption=!1,this.questionContainsSingleChoice=!1;let e=this.p.questions[t];if(null==e)return!1;this.checkIfAllMultipleChoiceAnswersAreCorrect(e),e.generalFeedbackStr="",e.allAnswersCorrect=!0;for(let t=0;t<e.inputs.length;t++){let s=e.inputs[t],l=e.solutionSymbols[s.solutionVariableId];switch(r(null!=l,"evaluate(): unknown solution symbol "+s.solutionVariableId+" known solution symbols: "+JSON.stringify(e.solutionSymbols)),l.type){case i.T_BOOL:this.evaluateBool(e,s,l);break;case i.T_REAL:this.evaluateReal(e,s,l);break;case i.T_COMPLEX:this.evaluateComplex(e,s,l);break;case i.T_FUNCTION:this.evaluateFunction(e,s,l);break;case i.T_STRING_LIST:this.evaluateStringList(e,s,l);break;case i.T_SET:case i.T_COMPLEX_SET:this.evaluateSet(e,s,l);break;case i.T_MATRIX:case i.T_MATRIX_OF_FUNCTIONS:this.evaluateMatrix(l.type==i.T_MATRIX_OF_FUNCTIONS,e,s,l);break;default:r(!1,"evaluate(): unimplemented math type: "+l.type.toString())}}return this.questionContainsSingleChoice&&0==this.selectedAnySingleChoiceOption&&(e.generalFeedbackStr+=x("no_answer_selected",this.p.language)),this.allMultipleChoiceAnswersAreCorrect||(e.generalFeedbackStr+=x("not_yet_correct",this.p.language)),!0}checkIfAllMultipleChoiceAnswersAreCorrect(t){this.allMultipleChoiceAnswersAreCorrect=!0;for(let e=0;e<t.inputs.length;e++){let s=t.inputs[e];if(s.solutionVariableId.includes("_mc_")){if("true"===s.studentAnswer[0]!=t.solutionSymbols[s.solutionVariableId].value){this.allMultipleChoiceAnswersAreCorrect=!1;break}}}}evaluateBool(t,e,s){let i="true"===e.studentAnswer[0];e.correct=s.value==i,e.evaluationFeedbackStr=e.correct?k:T,e.solutionVariableId.includes("_sc_")?(this.questionContainsSingleChoice=!0,0==i&&(e.evaluationFeedbackStr=""),1==i&&(this.selectedAnySingleChoiceOption=!0)):e.solutionVariableId.includes("_mc_")&&0==this.allMultipleChoiceAnswersAreCorrect&&(e.evaluationFeedbackStr=""),0==e.correct&&(t.allAnswersCorrect=!1)}evaluateReal(t,e,s){let i=e.studentAnswer[0].replaceAll(",","."),r=0,n="";try{r=l.evaluate(i),e.correct=l.abs(s.value-r)<s.precision}catch(s){n+=x("feedback_syntaxerror",this.p.language).replace("$",i)+"&nbsp;&nbsp;",e.correct=!1,t.allAnswersCorrect=!1}e.evaluationFeedbackStr=e.correct?k:T,e.evaluationFeedbackStr+=n,0==e.correct&&(t.allAnswersCorrect=!1)}evaluateComplex(t,e,s){let i=e.studentAnswer[0].replaceAll(",","."),r=e.studentAnswer[1].replaceAll(",","."),n=0,a=0,p="";e.correct=!0;try{n=l.evaluate(i)}catch(s){e.correct=!1,t.allAnswersCorrect=!1,p+=x("feedback_syntaxerror",this.p.language).replace("$",i)+"&nbsp;&nbsp;"}try{a=l.evaluate(r)}catch(s){e.correct=!1,t.allAnswersCorrect=!1,p+=x("feedback_syntaxerror",this.p.language).replace("$",r)+"&nbsp;&nbsp;"}if(e.correct){let t=l.complex(n,a);e.correct=l.abs(l.subtract(s.value,t))<s.precision}e.evaluationFeedbackStr=e.correct?k:T,e.evaluationFeedbackStr+=p,0==e.correct&&(t.allAnswersCorrect=!1)}evaluateStringList(t,e,s){let i=e.studentAnswer[0],r="";e.correct=!0;for(let n=0;n<s.value.length;n++){let a=s.value[n],p=f(i,a);p=l.abs(p);let h=a.length<=3?0==p:p<=2;if(r=a.length>3&&p>0&&p<=2?'<span class="text-warning">'+a+"</span>":"",0==h){e.correct=!1,t.allAnswersCorrect=!1;break}}e.evaluationFeedbackStr=e.correct?k:T,e.evaluationFeedbackStr+=r}evaluateFunction(t,e,s){let i=e.studentAnswer[0].replaceAll(",","."),l="";if(0==i.length&&(i="123456789123456789"),e.solutionVariableId in t.solutionSymbolsMustDiffFirst){let s=new c;if(0==s.importTerm(i))return t.allAnswersCorrect=!1,e.correct=!1,l+=x("feedback_syntaxerror",this.p.language).replace("$",i)+"&nbsp;&nbsp;",void(e.evaluationFeedbackStr=T+l);let r=t.solutionSymbolsMustDiffFirst[e.solutionVariableId];s=s.derivate(r),i=s.toString()}e.correct=s.value.compareWithStringTerm(i),0==e.correct&&(t.allAnswersCorrect=!1,"syntaxerror"===s.value.state&&(l+=x("feedback_syntaxerror_or_invalid_variables",this.p.language).replace("$",i)+"&nbsp;&nbsp;")),e.evaluationFeedbackStr=e.correct?k:T,e.evaluationFeedbackStr+=l}evaluateSet(t,e,s){let i=[],r=s.value.length,n="";for(let t=0;t<r;t++){let s=e.studentAnswer[t].replaceAll(",",".").replaceAll("j","i"),r=0;try{r=l.evaluate(s)}catch(t){n+=x("feedback_syntaxerror",this.p.language).replace("$",s)+"&nbsp;&nbsp;"}i.push(r)}let a=0;for(let t=0;t<r;t++){let e=s.value[t].value;for(let t=0;t<r;t++){let r=i[t];if(l.abs(l.subtract(e,r))<s.precision){a++;break}}}if(e.correct=a==r,a<r){t.allAnswersCorrect=!1;let e=x("i_out_of_n_correct",this.p.language)+"&nbsp;&nbsp;";e=e.replace("$i",""+a),e=e.replace("$n",""+r),n+=e}e.evaluationFeedbackStr=e.correct?k:T,e.evaluationFeedbackStr+=n}evaluateMatrix(t,e,s,i){let r=0,n=0;t?(r=i.value.m,n=i.value.n):(r=o.mat_get_row_count(i.value),n=o.mat_get_col_count(i.value)),s.correct=!0;let a="";if(s.matrixInput.m==r&&s.matrixInput.n==n||(s.correct=!1,e.allAnswersCorrect=!1,a+=x("dimensions_incorrect",this.p.language)+"&nbsp;&nbsp;"),s.correct)for(let p=0;p<r;p++){for(let r=0;r<n;r++){let h=p*n+r,u=s.studentAnswer[h].replaceAll(",","."),c=!0;if(t){if(c=i.value.elements[h].compareWithStringTerm(u),"syntaxerror"===i.value.state){s.correct=!1,e.allAnswersCorrect=!1,a+=x("feedback_syntaxerror_or_invalid_variables",this.p.language).replace("$",u)+"&nbsp;&nbsp;";break}}else{let t=0;try{t=l.evaluate(u)}catch(t){s.correct=!1,e.allAnswersCorrect=!1,a+=x("feedback_syntaxerror",this.p.language).replace("$",u)+"&nbsp;&nbsp;";break}if(l.abs(t-o.mat_get_element_value(i.value,p,r))>i.precision){s.correct=!1,e.allAnswersCorrect=!1;break}}if(!c){s.correct=!1,e.allAnswersCorrect=!1;let t=x("hint_matrix_element",this.p.language);t=t.replaceAll("$i",""+(p+1)),t=t.replaceAll("$j",""+(r+1)),a+=t+"&nbsp;&nbsp;";break}}if(0==s.correct)break}s.evaluationFeedbackStr=s.correct?k:T,s.evaluationFeedbackStr+=a}}var A;!function(t){t.UNKNOWN="unknown",t.TEXTFIELD="textfield",t.COMPLEX_NUMBER="textflield",t.CHECKBOX="checkbox",t.VECTOR="vector",t.MATRIX="matrix"}(A||(A={}));class S{constructor(){this.htmlElementId="",this.htmlElementInputType=A.UNKNOWN,this.htmlElementId_feedback="",this.solutionVariableId="",this.studentAnswer=[],this.evaluationFeedbackStr="",this.correct=!1,this.matrixInput=null,this.vectorLength=1}}class M{constructor(){this.idx=0,this.src="",this.html="",this.titleHtml="",this.bodyHtml="",this.bodyHtmlElement=null,this.symbols={},this.solutionSymbols={},this.solutionSymbolsMustDiffFirst={},this.lastParsedInputSymbol=null,this.stack=[],this.inputs=[],this.generalFeedbackStr="",this.allAnswersCorrect=!1}}class w{constructor(t=!1){this.evaluate=null,this.textParser=null,this.codeParser=null,this.codeSymParser=null,this.imParser=null,this.imInputParser=null,this.ELEMENT_TYPE_INPUT="input",this.ELEMENT_TYPE_SPAN="span",this.debug=!1,this.log="",this.language="en",this.generateInputFieldHtmlCode=!0,this.questions=[],this.q=null,this.qidx=0,this.html="",this.variablesJsonStr="",this.tokens=[],this.tk="",this.tk2="",this.tk_line=0,this.tk_col=0,this.tkIdx=0,this.id="",this.parseWhitespaces=!1,this.parsingInlineCode=!1,this.isBoldFont=!1,this.isItalicFont=!1,this.isItemize=!1,this.isItemizeItem=!1,this.singleMultipleChoiceFeedbackHTML="",this.resizableRows=!1,this.resizableCols=!1,this.uniqueIDCtr=0,this.editButton=!1,this.evaluate=new E(this),this.textParser=new h(this),this.codeParser=new d(this),this.codeSymParser=new b(this),this.imParser=new _(this),this.imInputParser=new g(this)}importQuestions(t){let e=(t=t.split("STOP")[0]).split("\n"),s="",i=0;for(let t=0;t<e.length;t++){let l=e[t];if(l.startsWith("%%%")){if(!this.importQuestion(s,i))return!1;s="",i=t+1}else s+=l+"\n"}return!!this.importQuestion(s,i)}importQuestion(t,e=0){this.resizableRows=!1,this.resizableCols=!1,this.tokens=[],this.tk="",this.tk_line=0,this.tk_col=0,this.tk2="",this.tkIdx=0,this.id="",this.qidx=this.questions.length,this.q=new M,this.q.idx=this.qidx,this.q.src=t,this.questions.push(this.q);let s=t.split("\n"),i=!1,l=!1;for(let t=0;t<s.length;t++){!l&&s[t].startsWith("```")&&(l=!0);let r=s[t].startsWith("\t\t")||s[t].startsWith("        "),n=s[t].startsWith("\t")||s[t].startsWith("    ");r&&(n=!1);let h=s[t].split("%")[0];if(0==h.length)continue;let o=p.tokenize(h);if(0!=o.length){o.push(new a("§EOL",t+1,-1)),l||(!n&&i&&this.tokens.push(new a("§CODE_END",t+1,-1)),n&&!i&&this.tokens.push(new a("§CODE_START",t+1,-1)));for(let s=0;s<o.length;s++)this.tokens.push(o[s]),this.tokens[this.tokens.length-1].line=e+t+1;i=n,l&&s[t].endsWith("```")&&(l=!1)}}this.tokens.push(new a("§END",-1,-1)),this.tkIdx=0,this.next();try{this.parse()}catch(t){return this.log+=t+"\n",this.log+="Error: compilation failed",!1}"§END"!==this.tk&&this.err('Error: remaining tokens: "'+this.tk+'"...'),this.log+="... compilation succeeded!\n";let r=[],n=this.q.html.length,h="";for(let t=0;t<n;t++){let e=this.q.html[t],s=t+1<n?this.q.html[t+1]:"";if("§"==e&&"["==s){h+="§"+r.length,r.push("");for(let i=t+2;i<n;i++){if(e=this.q.html[i],s=i+1<n?this.q.html[i+1]:"","]"==e&&"§"==s){t=i+1;break}r[r.length-1]+=e}}else h+=e}let o=r.length;for(let t=0;t<o;t++){let t=p.randomInt(0,o),e=p.randomInt(0,o),s=r[t];r[t]=r[e],r[e]=s}for(let t=0;t<o;t++)h=h.replace("§"+t,r[t]);return this.q.html=h,this.html+=this.q.html+"\n\n",!0}backupQuestion(t){let e=this.getQuestionByIdx(t);if(null==e)return null;let s={};s.source_code=e.src,s.title_html=e.titleHtml,s.body_html=e.bodyHtml,s.variables=[];for(let t in e.symbols)s.variables.push(e.symbols[t].exportDictionary(t));s.solution_variables=[];for(let t in e.solutionSymbols)s.solution_variables.push(e.solutionSymbols[t].exportDictionary(t));s.input_fields=[];for(let t=0;t<e.inputs.length;t++){let i=e.inputs[t],l={};l.element_type=i.htmlElementInputType,l.element_id=i.htmlElementId,l.element_id__feedback=i.htmlElementId_feedback,l.correct=i.correct,l.feedback_message=i.evaluationFeedbackStr,l.student_answer_string=i.studentAnswer,l.solution_variable_id=i.solutionVariableId,s.input_fields.push(l)}return s.general_feedback={},s.general_feedback.all_answers_correct=e.allAnswersCorrect,s.general_feedback.feedback_message=e.generalFeedbackStr,JSON.stringify(s,null,4)}getQuestionInputFields(t){let e=[],s=this.backupQuestion(t),i=JSON.parse(s);for(let t=0;t<i.input_fields.length;t++)e.push({element_id:i.input_fields[t].element_id,element_type:i.input_fields[t].element_type,solution_variable_id:i.input_fields[t].solution_variable_id});return e}createQuestionFromBackup(t){let e=JSON.parse(t),s=new M;s.idx=this.questions.length,s.src=e.source_code,s.titleHtml=e.title_html,s.bodyHtml=e.body_html,s.symbols={};for(let t=0;t<e.variables.length;t++){let i=e.variables[t],l=new n;l.importDictionary(i),s.symbols[i.id]=l}s.solutionSymbols={};for(let t=0;t<e.solution_variables.length;t++){let i=e.solution_variables[t],l=new n;l.importDictionary(i),s.solutionSymbols[i.id]=l}s.inputs=[];for(let t=0;t<e.input_fields.length;t++){let i=new S,l=e.input_fields[t];i.htmlElementInputType=l.element_type,i.htmlElementId=l.element_id,i.htmlElementId_feedback=l.element_id__feedback,i.correct=l.correct,i.evaluationFeedbackStr=l.feedback_message,i.studentAnswer=l.student_answer_string,i.solutionVariableId=l.solution_variable_id,s.inputs.push(i)}return s.allAnswersCorrect=e.general_feedback.all_answers_correct,s.generalFeedbackStr=e.general_feedback.feedback_message,this.questions.push(s),s.idx}getElementByIdAndType(t,e){return document.getElementById(t)}backupLexer(){return{tk:this.tk,tk_line:this.tk_line,tk_col:this.tk_col,tk2:this.tk2,tkIdx:this.tkIdx,id:this.id}}replayLexer(t){this.tk=t.tk,this.tk_line=t.tk_line,this.tk_col=t.tk_col,this.tk2=t.tk2,this.tkIdx=t.tkIdx,this.id=t.id}createUniqueID(){return"ID"+this.uniqueIDCtr++}updateMatrixInputs(t){let e=this.getQuestionByIdx(t);if(null==e)return!1;for(let t=0;t<e.inputs.length;t++){let s=e.inputs[t];null!=s.matrixInput&&s.matrixInput.updateHTML()}return!0}updateMatrixDims(t,e,s,i){let l=this.getQuestionByIdx(t);if(null==l)return!1;for(let t=0;t<l.inputs.length;t++){let r=l.inputs[t];null!=r.matrixInput&&r.htmlElementId==e&&r.matrixInput.resize(s,i)}return!0}next(){if(this.tkIdx>=this.tokens.length?(this.tk="§END",this.tk_line=-1,this.tk_col=-1):(this.tk=this.tokens[this.tkIdx].str,this.tk_line=this.tokens[this.tkIdx].line,this.tk_col=this.tokens[this.tkIdx].col),this.tkIdx+1>=this.tokens.length?this.tk2="§END":this.tk2=this.tokens[this.tkIdx+1].str,this.tkIdx++,this.parseWhitespaces||" "!==this.tk||this.next(),this.parsingInlineCode&&p.isIdentifier(this.tk))for(;this.parsingInlineCode&&this.tkIdx<this.tokens.length-1&&"§END"!==this.tk&&("_"===this.tokens[this.tkIdx].str||p.isIdentifier(this.tokens[this.tkIdx].str)||p.isInteger(this.tokens[this.tkIdx].str));)this.tk+=this.tokens[this.tkIdx].str,this.tk_line=this.tokens[this.tkIdx].line,this.tk_col=this.tokens[this.tkIdx].col,this.tkIdx++;this.parseWhitespaces||" "!==this.tk||this.next()}err(t){throw"Error:"+this.tk_line+":"+this.tk_col+": "+t}terminal(t){this.tk===t?this.next():this.err("§EOL"==t?"expected linebreak, got '"+this.tk+"'":"expected '"+t+"'")}ident(){this.isIdent()?(this.id=this.tk,this.next()):this.err("expected identifier")}isIdent(){return p.isIdentifier(this.tk)}isNumber(){return!isNaN(this.tk)}isInt(){return p.isInteger(this.tk)}is(t){return this.tk===t}is2(t){return this.tk2===t}isNumberInt(t){return Math.abs(t-Math.round(t))<1e-6}pushSym(t,e,s=1e-9){this.q.stack.push(new n(t,e,s))}charToHTML(t){switch(t){case"§EOL":return"<br/>\n";default:return t}}parse(){for(this.textParser.parseTitle(),this.q.html="";!this.is("§END");)this.is("§CODE_START")?this.codeParser.parseCode():this.textParser.parseText();this.q.bodyHtml=this.q.html,this.createHighLevelHTML()}createHighLevelHTML(){this.q.html='<div id="sell_question_html_element_'+this.q.idx+'" class="card">\n',this.q.html+='<div class="card-header">\n',this.q.html+='    <h5 class="card-title m-0">'+this.q.titleHtml+"</h5>\n",this.q.html+='    <a name="question-'+(this.questions.length-1)+'"></a>\n',this.q.html+="</div>\n",this.q.html+='<div class="card-body p-4">\n',this.q.html+=this.q.bodyHtml,this.q.html+="</div>\n",this.q.html+='<div class="card-footer bg-white pl-4 pt-2 pb-1 m-0">',this.q.html+="<span>",this.q.html+='<input type="image" id="button-evaluate" onclick="sellquiz.autoEvaluateQuiz('+this.qidx+", 'sell_question_html_element_"+this.q.idx+'\');" height="28px" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcKICAgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIgogICB4bWxuczpjYz0iaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbnMjIgogICB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiCiAgIHhtbG5zOnN2Zz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKICAgeG1sbnM6c29kaXBvZGk9Imh0dHA6Ly9zb2RpcG9kaS5zb3VyY2Vmb3JnZS5uZXQvRFREL3NvZGlwb2RpLTAuZHRkIgogICB4bWxuczppbmtzY2FwZT0iaHR0cDovL3d3dy5pbmtzY2FwZS5vcmcvbmFtZXNwYWNlcy9pbmtzY2FwZSIKICAgdmlld0JveD0iMCAwIDQ0OCA1MTIiCiAgIHZlcnNpb249IjEuMSIKICAgaWQ9InN2ZzgzNSIKICAgc29kaXBvZGk6ZG9jbmFtZT0iY2hlY2stc3F1YXJlLnN2ZyIKICAgaW5rc2NhcGU6dmVyc2lvbj0iMS4wLjEgKGM0OTdiMDNjLCAyMDIwLTA5LTEwKSI+CiAgPG1ldGFkYXRhCiAgICAgaWQ9Im1ldGFkYXRhODQxIj4KICAgIDxyZGY6UkRGPgogICAgICA8Y2M6V29yawogICAgICAgICByZGY6YWJvdXQ9IiI+CiAgICAgICAgPGRjOmZvcm1hdD5pbWFnZS9zdmcreG1sPC9kYzpmb3JtYXQ+CiAgICAgICAgPGRjOnR5cGUKICAgICAgICAgICByZGY6cmVzb3VyY2U9Imh0dHA6Ly9wdXJsLm9yZy9kYy9kY21pdHlwZS9TdGlsbEltYWdlIiAvPgogICAgICAgIDxkYzp0aXRsZT48L2RjOnRpdGxlPgogICAgICA8L2NjOldvcms+CiAgICA8L3JkZjpSREY+CiAgPC9tZXRhZGF0YT4KICA8ZGVmcwogICAgIGlkPSJkZWZzODM5IiAvPgogIDxzb2RpcG9kaTpuYW1lZHZpZXcKICAgICBwYWdlY29sb3I9IiNmZmZmZmYiCiAgICAgYm9yZGVyY29sb3I9IiM2NjY2NjYiCiAgICAgYm9yZGVyb3BhY2l0eT0iMSIKICAgICBvYmplY3R0b2xlcmFuY2U9IjEwIgogICAgIGdyaWR0b2xlcmFuY2U9IjEwIgogICAgIGd1aWRldG9sZXJhbmNlPSIxMCIKICAgICBpbmtzY2FwZTpwYWdlb3BhY2l0eT0iMCIKICAgICBpbmtzY2FwZTpwYWdlc2hhZG93PSIyIgogICAgIGlua3NjYXBlOndpbmRvdy13aWR0aD0iMTgxNCIKICAgICBpbmtzY2FwZTp3aW5kb3ctaGVpZ2h0PSIxMTI4IgogICAgIGlkPSJuYW1lZHZpZXc4MzciCiAgICAgc2hvd2dyaWQ9ImZhbHNlIgogICAgIGlua3NjYXBlOnpvb209IjEuNDkxMDcxNCIKICAgICBpbmtzY2FwZTpjeD0iMjI0IgogICAgIGlua3NjYXBlOmN5PSIyNTYiCiAgICAgaW5rc2NhcGU6d2luZG93LXg9IjAiCiAgICAgaW5rc2NhcGU6d2luZG93LXk9IjIzIgogICAgIGlua3NjYXBlOndpbmRvdy1tYXhpbWl6ZWQ9IjAiCiAgICAgaW5rc2NhcGU6Y3VycmVudC1sYXllcj0ic3ZnODM1IiAvPgogIDxwYXRoCiAgICAgZD0iTTQwMCAzMkg0OEMyMS40OSAzMiAwIDUzLjQ5IDAgODB2MzUyYzAgMjYuNTEgMjEuNDkgNDggNDggNDhoMzUyYzI2LjUxIDAgNDgtMjEuNDkgNDgtNDhWODBjMC0yNi41MS0yMS40OS00OC00OC00OHptMCA0MDBINDhWODBoMzUydjM1MnptLTM1Ljg2NC0yNDEuNzI0TDE5MS41NDcgMzYxLjQ4Yy00LjcwNSA0LjY2Ny0xMi4zMDMgNC42MzctMTYuOTctLjA2OGwtOTAuNzgxLTkxLjUxNmMtNC42NjctNC43MDUtNC42MzctMTIuMzAzLjA2OS0xNi45NzFsMjIuNzE5LTIyLjUzNmM0LjcwNS00LjY2NyAxMi4zMDMtNC42MzcgMTYuOTcuMDY5bDU5Ljc5MiA2MC4yNzcgMTQxLjM1Mi0xNDAuMjE2YzQuNzA1LTQuNjY3IDEyLjMwMy00LjYzNyAxNi45Ny4wNjhsMjIuNTM2IDIyLjcxOGM0LjY2NyA0LjcwNiA0LjYzNyAxMi4zMDQtLjA2OCAxNi45NzF6IgogICAgIGlkPSJwYXRoODMzIiAvPgo8L3N2Zz4K" title="evaluate"></input>',this.editButton&&(this.q.html+='&nbsp;&nbsp;<button type="button" class="btn btn-link" onclick="editSellQuestion('+this.qidx+')">edit</button>'),this.q.html+='&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id="general_feedback"></span>',this.q.html+="</span>",this.q.html+="</div>",this.q.html+="</div>\n",this.q.html+="<br/>"}getQuestionByIdx(t){return t<0||t>=this.questions.length?null:this.questions[t]}enableInputFields(t,e=!0){let s=this.getQuestionByIdx(t);if(null==s)return!1;null==s.bodyHtmlElement&&r(!1,"enableInputFields(): q.bodyHtmlElement was not set");for(let t=0;t<s.inputs.length;t++){v(s.bodyHtmlElement,s.inputs[t].htmlElementId).disabled=!e}return!0}}var C=new w;function O(t,e){let s=C.getQuestionByIdx(t);return null!=s&&(s.bodyHtmlElement=e,!0)}function L(t){return C.evaluate.evaluate(t)}function N(t){return C.evaluate.getStudentAnswers(t)}function R(t){return C.evaluate.displayFeedback(t)}function z(t){let e=C.getQuestionByIdx(t);return null==e?"":e.generalFeedbackStr}function q(t){return C.updateMatrixInputs(t)}return t.autoCreateQuiz=function(t,e){if(0==C.importQuestions(t))return!1;e.innerHTML=C.html;for(let t=0;t<C.questions.length;t++){let s=C.questions[t].idx;O(s,v(e,"sell_question_html_element_"+s)),q(s)}return!0},t.autoEvaluateQuiz=function(t,e){let s=document.getElementById(e);if(r(null!=s,"autoEvaluateQuiz(..): question HTML element is null"),N(t),0==L(t))return!1;R(t);let i=v(s,"general_feedback");return r(null!=i,"autoEvaluateQuiz(..): feedback HTML element is null"),i.innerHTML=z(t),!0},t.backupQuestion=function(t){return C.backupQuestion(t)},t.createQuestion=function(t){return 0==C.importQuestion(t)?-1:C.qidx},t.createQuestionFromBackup=function(t){return C.createQuestionFromBackup(t)},t.disableInputFields=function(t){return C.enableInputFields(t,!1)},t.enableInputFields=function(t){return C.enableInputFields(t,!1)},t.evaluateQuestion=L,t.getErrorLog=function(){return C.log},t.getFeedbackText=z,t.getQuestionBody=function(t){let e=C.getQuestionByIdx(t);return null==e?"":e.bodyHtml},t.getQuestionInputFields=function(t){return C.getQuestionInputFields(t)},t.getQuestionTitle=function(t){let e=C.getQuestionByIdx(t);return null==e?"":e.titleHtml},t.getScore=function(t){return C.evaluate.getScore(t)},t.readStudentAnswersFromHtmlElements=N,t.refreshMatrixDimensions=function(t,e,s,i){return C.updateMatrixDims(t,e,s,i)},t.refreshQuestion=q,t.reset=function(){C=new w},t.setGenerateInputFieldHtmlCode=function(t=!0){C.generateInputFieldHtmlCode=t},t.setLanguage=function(t){C.language=t},t.setQuestionHtmlElement=O,t.setStudentAnswerManually=function(t,e,s){return C.evaluate.setStudentAnswerManually(t,e,s)},t.writeFeedbackToHtmlElements=R,Object.defineProperty(t,"__esModule",{value:!0}),t}({},math);
